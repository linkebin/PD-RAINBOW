<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>新建规则</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/Styles/themes/default/style.css" media="all">
    <link rel="stylesheet" href="/Scripts/libs/ztree/css/demo.css" media="all">
    <link rel="stylesheet" href="/Scripts/libs/ztree/css/metroStyle/metroStyle.css" type="text/css">
    <style>
        #channelAdd input + label{color: red;}
    </style>
</head>
<body>

<form class="eui-form eui-padding10" id="channelAdd" onsubmit="return false;">
    <input type="hidden" name="ruleId" id="ruleId" th:value="${UUID}" />
    <input type="hidden" name="add"  value="1" />
    <div class="eui-form-item">
        <label class="eui-form-label">规则比例</label>
        <div class="eui-input-inline">
            <input type="text" name="rule" e-verify="title"  autocomplete="off" placeholder="请输入规则比例" class="eui-input" />

        </div>
        <label class="eui-form-label">规则名称</label>
        <div class="eui-input-inline">
            <input type="text" name="ruleName" e-verify="title" autocomplete="off" placeholder="请输入规则名称" class="eui-input" >
        </div>

        <label class="eui-form-label">是否默认</label>
        <div class="eui-input-inline">
            <input type="radio" value="0" checked="checked"  name="defaultRule" title="否">
            <input type="radio" value="1"  name="defaultRule" title="是" >
        </div>
    </div>

    <div class="eui-form-item">
        <label class="eui-form-label">开始时间</label>
        <div class="eui-input-inline">
            <input type="text" name="startTime" e-verify="title" id="startTime" readonly="readonly"  placeholder="请输入规则开始时间" class="eui-input">
        </div>

        <label class="eui-form-label">结束时间</label>
        <div class="eui-input-inline">
            <input type="text" name="endTime" e-verify="title" id="endTime" readonly="readonly"   placeholder="请输入规则结束时间" class="eui-input" >
        </div>

    </div>
    <div style="display: none"> <button type="submit" id="SF" class="eui-btn eui-btn-small"></button></div>
</form>

<div class="eui-bg-white eui-row eui-padding10">
    <div class="eui-row eui-padding10 eui-borderB">
        <div class="eui-col-md6 eui-font18">
            <i class='eui-icon eui-font24'>&#xe61d;</i> 已选的渠道
        </div>
        <div class="eui-col-md6 eui-textAlignR">
            <a href="###" class="eui-btn eui-btn-small promotionNew" onclick="selectChannel()"><i
                    class='eui-icon eui-font24'>&#xe61d;</i>添加渠道</a>
        </div>
    </div>
    <table class="eui-table eui-form" id="productTable">
        <colgroup>
            <col width="120">
            <col>
        </colgroup>
        <thead>
        <tr>
            <th>渠道编号</th>
            <th>渠道名称</th>
            <th>联系人</th>
            <th>联系人电话</th>
            <th>渠道负责人</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
    <div style="margin-left: 30px;" id="pages"></div>

    <div class="eui-textAlignC eui-bg-white eui-padding20">
            <span onclick="formSub()" class="eui-btn eui-btn-big confirm">
                <img src="/Styles/images/xymfImages/submit.png" width="24" alt=""> 保存信息</span>
    </div>

</div>
</body>
<script src="/Scripts/module/eui.js" charset="utf-8"></script>
<script src="/Scripts/main.js" charset="utf-8"></script>
<script type="text/javascript" src="/Scripts/jquery-1.9.0.min.js"></script>
<script src="/pack.ajax.js" type="text/javascript"></script>
<script src="/Scripts/date2format.js" type="text/javascript"></script>
<script src="/Scripts/plugins/jquery.validate.js"></script>
<script>

    function getRuleObj() {
       return $("#channelAdd").serializeObject();
    }

    function formSub() {
        return $("#SF").click();
    }

    eui.use(['form', 'layedit', 'laydate'], function(){
        var form = eui.form
            ,layer = eui.layer
            ,layedit = eui.layedit
            ,laydate = eui.laydate;

        //常规用法
        laydate.render({
            elem: '#startTime'
            ,done: function(value, date, endDate){
                delededAll();
            }
        });
        laydate.render({
            elem: '#endTime'
            ,done: function(value, date, endDate){
                delededAll();
            }
        });
        laydate.render({
            elem: '#joinTime6'
            ,range: true
            ,change: function(value, date, endDate){
                var startTime=value.split(' - ')[0];
                var endTime=value.split(' - ')[1];
                $("#joinStartTime").val(startTime);
                $("#joinEndTime").val(endTime);
            }
        });

        form.on('radio(defaultRule)', function(data){
            $('#radionull').html('');
        });

        jQuery.validator.methods.compareDate = function(value, element, param) {
            var startDate = jQuery(param).val();
            var date1 = new Date(Date.parse(startDate.replace("-", "/")));
            var date2 = new Date(Date.parse(value.replace("-", "/")));
            return date1 < date2;
        };
        $("#channelAdd").validate({
            rules: {
                rule: {
                    required : true
                },
                ruleName:"required",
                startTime:"required",
                endTime:{
                    required : true,
                    compareDate : "#startTime"
                }
            },
            messages: {
                rule: {
                    required : "请输入规则比例",
                },
                ruleName: "请输入规则名称",
                startTime:"请输入规则开始时间",
                endTime:{
                    required:"请输入规则结束时间",
                    compareDate: "结束时间必须大于开始时间!"
                }
            },
            showErrors : function(errorMap, errorList) {
                this.defaultShowErrors();
            },
            success:function(label) {

            },
            submitHandler: function() {
                addAccountRule();
            }
        });
    });

    function delededAll() {
        $.post('/channel/rule/deleteAll',{"ruleId":$("#ruleId").val()},function (res) {
            if (res.code==200){
                doSearch();
            }else{
                layer.msg(res.message);
                location.reload();
            }
        });
    }

    var taskTeamInfoiframeWin =null ;
    function selectChannel() {

        var obj = getRuleObj();
        if (obj.startTime==''&&obj.endTime==''){
            layer.msg("请选择开始时间和结束时间！")
            return;
        }

        var index = layer.open({
            type: 2 //此处以iframe举例
            ,title: '渠道商选择'
            ,area: ['1200px', '600px']
            ,shade: 0
            ,maxmin: true
            ,btn: ['确定', '取消']
            ,content: '/web/channel/manage/selectchannel'
            ,success: function(layero, index){
                var body = layer.getChildFrame('body', index);
                taskTeamInfoiframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：
            }
            ,yes: function(){
                var ids = taskTeamInfoiframeWin.selectIds();
                if (ids!=''){
                    $.post('/channel/rule/add',{channelIds:ids,ruleId:$("#ruleId").val()},function (result) {
                        layer.closeAll();
                    });
                }else {
                    layer.msg("请选择数据！")
                }
            }
            ,btn2: function(){
                layer.closeAll();
            }
        });
    }

    function addAccountRule() {
        var obj = $("#channelAdd").serializeObject();
            if (obj.defaultRule!=undefined){
                if (obj.defaultRule=='1'){
                    layer.confirm('当前新建的规则选择了默认规则，将会覆盖之前的默认规则。请确定是否覆盖？', {
                        btn: ['确认', '取消'],
                        shade: 0,
                        title:'提示'
                    }, function(r){
                        layer.load();
                        accountRule1(obj);
                    },function () {
                        obj.defaultRule=0;
                        accountRule1(obj);
                    });
                }else {
                    accountRule1(obj);
                }

            }else {
                layer.closeAll();
                layer.msg('是否默认不能为空');
            }
    }
    function accountRule1(obj) {
        layer.load();
        $.post('/account/rule/add',{json:JSON.stringify(obj)},function (resuslt) {
            resultHint(resuslt);
        });
    }

    function resultHint(resuslt) {
        var msg = resuslt.message;
        if(msg=="SUCCESS"){
            layer.msg('保存成功', {
                icon: 1,
                time: 3000
            }, function(){
                parent.element.tabDelete("nav-tab",'xdcvb');

            });
        }else{
            layer.msg(msg, {
                time: 4000
            });
        }
        layer.closeAll();
    }
</script>
</html>