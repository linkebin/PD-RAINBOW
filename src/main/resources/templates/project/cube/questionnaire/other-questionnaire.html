<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <title>问卷填写</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/Styles/themes/default/style.css" rel="stylesheet" type="text/css"/>
</head>
<body class="questionBody">

<div class="questionHeader">
    <input type="hidden" th:value="${#httpServletRequest.getParameter('questionnaireId')}" id="questionnaireId"/>
    <input type="hidden" th:value="${userId}" id="userId"/>
    <div class="eui-row eui-area">
        <div class="xymfLogo">
            <img src="../../Styles/images/xymfImages/xymf/logo.png" alt="">
            <span class="payCentre">问卷填写</span>
        </div>
    </div>
</div>

<div class="visitorContent xymfMargin">
    <div class="eui-area" style="width: 800px">
        <div class="eui-row visitorTitle">
            <div class="eui-col-xs7">
                <div> 问题卡</div>
            </div>
            <div class="eui-col-xs5 eui-textAlignR">
                <div> 计时: <span id="timer">00:00:00</span></div>
            </div>
        </div>

        <div id="divSuccess" class="eui-bg-white eui-padding20 visitor">
            <form>
                <input type="hidden" th:value="${questionnaireId}" id="questionnaireId"/>
                <input type="hidden" th:value="${userId}" id="userId"/>
                <input type="hidden" th:value="${visitorTimes}" id="visitorTimes"/>
                <input type="hidden" th:value="${activityId}" id="activityId"/>
                <input type="hidden" th:value="${userName}" id="userName"/>
                <!--<div class="eui-form-item eui-padding20">
                  <span id="remarks">
                      下面列出了有些人可能会有的问题，请仔细阅读每一条，然后根据最新一星期以内，您的实际感觉，选择适合的答案点击，请注意不要漏题。
                 </span>
                    <hr/>
                </div>-->
                <div class="eui-bg-white eui-form" id="divTable">
                    <!--  问题内容-->
                </div>
            </form>
        </div>
        <div class="eui-textAlignC eui-bg-white eui-padding20" id="submitBnt">
            <button onclick="submitQuestionnaire()" class="eui-btn eui-btn-normal eui-btn-big" id="confirm"><img
                    src="/Styles/images/xymfImages/submit.png" width="24" alt=""> 提交问卷
            </button>
        </div>
    </div>
</div>
<!--<div class="xymfFooter">-->
<!--<div class="eui-area eui-row">-->
<!--<div class="eui-col-md2">-->
<!--<dl class="eui-lineHeight24 eui-color-gray3">-->
<!--<dt class="eui-darkgreen eui-font16 eui-paddingTB20">关于我们</dt>-->
<!--<dd>关于我们</dd>-->
<!--<dd>注册协议</dd>-->
<!--<dd>保密协议</dd>-->
<!--<dd>帮助中心</dd>-->
<!--</dl>-->
<!--</div>-->
<!--<div class="eui-col-md3">-->
<!--<dl>-->
<!--<dt class="eui-darkgreen eui-font16 eui-paddingTB20">联系我们</dt>-->
<!--<dd class="visitorPhone1 eui-marginB20">-->
<!--<p class="eui-darkgreen eui-font16">020-82314165</p>-->
<!--<p class="eui-color-gray3 eui-font12">平台全国服务热线</p>-->
<!--</dd>-->
<!--<dd class="visitorPhone2">-->
<!--<p class="eui-darkgreen eui-font16">15622183952</p>-->
<!--<p class="eui-color-gray3 eui-font12">24小时移动热线，实时在您的身边</p>-->
<!--</dd>-->
<!--</dl>-->
<!--</div>-->
<!--<div class="eui-col-md2 eui-col-md-offset5 eui-textAlignR">-->
<!--<dl>-->
<!--<dt class="eui-darkgreen eui-font16 eui-padding20">微信公众号</dt>-->
<!--<dd><img src="/Styles/images/xymfImages/QRcode.png" alt=""></dd>-->
<!--</dl>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->

<div class="xymfFooter">
    <!-- 底部固定区域 -->
    © 2017 广州市易度软件开发有限公司旗下心云魔方品牌
</div>


<!-- 返回顶部按钮 -->
<span class="eui-icon eui-backTop" e-type="top">&#xe604;</span>

<script src="/Scripts/module/eui.js"></script>
<script type="text/javascript" src="/Scripts/jquery-1.9.0.min.js"></script>
<script th:inline="javascript">
    eui.use(['form', 'layedit', 'laydate'], function () {
        var form = eui.form
                , layer = eui.layer
                , layedit = eui.layedit
                , laydate = eui.laydate;

        //常规用法
        laydate.render({
            elem: '#test1'
        });

//radio的事件监听
        form.on('radio(filter)', function (data) {
            console.log(data.elem); //得到radio原始DOM对象

            if (data.elem.attributes.states.value == '0') {
                data.elem.checked = true;
                form.render();
                data.elem.attributes.states.value = '1';
            } else {
                data.elem.checked = false;
                form.render();
                data.elem.attributes.states.value = '0';
            }


        });

    });
    // 返回顶部
    var winH = $(window).height();

    $('.eui-backTop').hide();
    $(window).scroll(function (e) {
        var winT = $(window).scrollTop();
        if (winT > winH) {
            $('.eui-backTop').fadeIn()
        } else {
            $('.eui-backTop').fadeOut()
        }
    });

    $('.eui-backTop').click(function (e) {
        $('html,body').animate({scrollTop: 0}, 500)
    });
    //初始化数据
    var questionnaire = [[${questionnaire}]];
    console.info("questionnaire");
    console.info(questionnaire);
    $(function () {
        loadQuestion();
        if (questionnaire.remarks != "") {
            $("#remarks").text(questionnaire.remarks);
        }
    });

    //问卷id
    var questionnaireId = $("#questionnaireId").val();

    //加载问卷
    function loadQuestion() {
        eui.use(['form', 'laypage', 'layer'], function () {
            var form = eui.form
                    , laypage = eui.laypage
                    , layer = eui.layer,
                    $ = eui.jquery;
            var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
            $.post("/cube/questionnaire/question/findQuestionForQuestionnaire", {"id": questionnaireId}, function (result) {
                layer.closeAll();
                var context = getTable(result.data);
                $("#divTable").html(context);
                formRender();
            });
        });

    }

    //拼接问题
    function getTable(questionList) {
        var context = "";
        for (var i in questionList) {
            context += '<div questionType="' + questionList[i].questionType + '" ' +
                    'radioNmae="answer' + questionList[i].id + '" ' +
                    'correctAnswer="' + questionList[i].answer + '" ' +
                    'questionId="' + questionList[i].id + '"  ' +
                    'class="eui-form-item eui-padding20" name="divQuestion">';
            context += '<div class="eui-font18">';
            if (questionList[i].questionType == 2) {
                context += (parseInt(i) + 1) + "." + questionList[i].questionContent + "（多选）";
            } else {
                context += (parseInt(i) + 1) + "." + questionList[i].questionContent + "（单选）";
            }
            context += '</div>';
            var optionAnswer = questionList[i].optionAnswer.split("||");
            var optionScore = questionList[i].optionScore.split("||");
            for (var j in optionAnswer) {
                //判断问题答案的正反序 1 正 2反
                var sequence = 0;
                if (questionList[i].answerSequence == 1) {
                    sequence = parseInt(j);
                } else {
                    sequence = optionAnswer.length - parseInt(j) - 1;
                }
                //判断问题是单选还是多选 2多选
                var radioName = "";
                if (questionList[i].questionType == 2) {
                    radioName = 'answer' + questionList[i].id + j;
                    context += '  <input e-filter="filter" type="radio" states="0"  optionScore="' + optionScore[sequence] + '" ';
                } else {
                    radioName = 'answer' + questionList[i].id;
                    context += '  <input type="radio" states="0"  optionScore="' + optionScore[sequence] + '" ';
                }


                context += '  name="' + radioName + '"';
                context += ' value="' + optionAnswer[j] + '" ';
                context += ' title="' + optionAnswer[j] + '" />';

            }
            context += ' </div>';
        }
        return context;
    }
    //给所有的radio单机事件

    /* if($(this).prop("checked")){
     $(this).prop("checked",false);
     }*/


    //判断计算那些问题没有做
    function flg() {
        var result = "";
        var questions = $("[name='divQuestion']");
        for (var i = 0; i < questions.length; i++) {
            //题目的序号
            var num = parseInt(i) + 1;
            //当前第一个对象
            var question = questions.eq(i);
            //获得子的个数
            var size = question.children("input").length;
            //循环当前问题的选项 看有没有被选中
            var state = 0;
            for (var j = 0; j < size; j++) {

                if (question.children("input").eq(j).prop("checked")) {
                    state = 1;
                }
            }
            if (state == 0) {
                //state=0 说明没有做这道题
                result += num + ","
            }

        }
        if (result != "") {
            result += "题没有做，请答完！";
            layer.msg(result, {
                icon: 1,
                time: 5000
            });
        }
        return result;
    }
    //提交问卷
    function submitQuestionnaire() {

        var state = flg();
        //state=""  则是题目都已经做完
        if (state == "") {
            var divQuestions = $("[name='divQuestion']");
            var array = new Array;
            for (var i = 0; i < divQuestions.length; i++) {
                //获取所有被选中的radio元素
                var radios = divQuestions.eq(i).children("input:radio:checked");
                var answer = "";
                var score = "";
                for (var r = 0; r < radios.length; r++) {
                    answer = answer + "||" + radios.eq(r).val();
                    score = score + "||" + radios.eq(r).attr("optionScore");
                }
                answer = answer.substring(2, answer.length);
                score = score.substring(2, score.length);
                var obj = new Object();
                //分数
                obj.score = score;
                //问题
                obj.questionId = divQuestions.eq(i).attr("questionId");
                //选择的答案（列子：A:1  B:2  答案： A:1  或者多选  ）
                obj.answer = answer;
                //正确答案
                obj.correctAnswer = divQuestions.eq(i).attr("correctAnswer");
                //答案类型
                obj.questionType = divQuestions.eq(i).attr("questionType");
                array.push(obj);
            }
            //耗时
            var visitorTimes = $("#visitorTimes").val();
            var questionnaireId = $("#questionnaireId").val();
            var userId = $("#userId").val();
            var timeConsuming = $("#timer").text();
            var activityId = $("#activityId").val();
            var userName = $('#userName').val();
            //加载层
            var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
            $('#confirm').attr("disabled", true);
            $('#confirm').text("正在提交中...");
            $.post("/launch/activities/getActivityById", {id: activityId}, function (result) {
                console.log(result);
                if (result.code == 200) {
                    if (result.data != null) {
                        var activity = result.data;
                        $.post('/data/acquisition/findCount', {activityId: activity.id}, function (res) {
                            console.log(res.data);
                            if (res.code == 200) {
                                if (res.data >= activity.activityTotal) {
                                    layer.confirm('活动已结束', {
                                        btn: ['确定']
                                    })
                                    layer.close(index);
                                    remove();
                                } else {
                                    $.post("/cube/questionnaire/subQuestionnaire",
                                            {
                                                "param": JSON.stringify(array),
                                                "questionnaireId": questionnaireId,
                                                "userId": userId,
                                                "visitorTimes": visitorTimes,
                                                "timeConsuming": timeConsuming,
                                                "activityId": activityId,
                                                "userName": userName
                                            }, function (result) {
                                                layer.closeAll();
                                                console.log(result);
                                                if (result.code == 200) {
                                                    window.location.href = "/web/cube/getSuccess";
                                                } else {
                                                    layer.msg('填写失败', {
                                                        icon: 2,
                                                        time: 3000
                                                    });
                                                    remove();
                                                }
                                            });
                                }
                            } else {
                                layer.msg(result.message, {
                                    icon: 2,
                                    time: 3000
                                });
                                layer.close(index);
                                remove();
                            }
                        })
                    } else {
                        layer.confirm('活动已结束', {
                            btn: ['确定']
                        })
                        layer.close(index);
                        remove();
                    }
                } else {
                    layer.msg(result.message);
                    layer.close(index);
                    remove();
                }
            })
        }
    }

    function remove() {
        $('#confirm').removeAttr("disabled");
        $('#confirm').text("提交问卷");
    }

    //form表单  select,checkbox,radio 动态添加  需要更新
    function formRender() {
        eui.use(['form'], function () {
            var form = eui.form;
            form.render();
        });
    }


    //计时器

    var ele_timer = $("#timer");
    var n_sec = 0; //秒
    var n_min = 0; //分
    var n_hour = 0; //时

    //60秒 === 1分
    //60分 === 1小时
    function timer() {
        return setInterval(function () {

            var str_sec = n_sec;
            var str_min = n_min;
            var str_hour = n_hour;
            if (n_sec < 10) {
                str_sec = "0" + n_sec;
            }
            if (n_min < 10) {
                str_min = "0" + n_min;
            }

            if (n_hour < 10) {
                str_hour = "0" + n_hour;
            }

            var time = str_hour + ":" + str_min + ":" + str_sec;
            ele_timer.text(time);
            n_sec++;
            if (n_sec > 59) {
                n_sec = 0;
                n_min++;
            }
            if (n_min > 59) {
                n_sec = 0;
                n_hour++;
            }


        }, 1000);
    }
    var n_timer = timer();

    //暂停和继续
    function pause(self) {
        var state = self.getAttribute("state");
        if (state === "on") {
            clearInterval(n_timer);
            self.textContent = "继续";
            self.setAttribute("state", "off");
        } else {
            n_timer = timer();
            self.textContent = "暂停";
            self.setAttribute("state", "on");
        }
    }


</script>

</body>
</html>
