<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <title>活动编辑</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/Styles/themes/default/style.css" rel="stylesheet" type="text/css"/>
    <style>
        .default_hide {
            display: none;
        }

        .eui-form-label {
            width: 100px;
            text-align: left;
        }

        #activitiesForm input + label, select + label {
            color: red;
        }
    </style>
</head>
<body>
<div class="questionHeader">
    <div class="eui-row eui-area">
        <div class="xymfLogo">
            <img src="/Styles/images/xymfImages/xymf/logo.png" alt="">
            <span class="payCentre">编辑活动</span>
        </div>
    </div>
</div>

<div class="activityContent xymfMargin">
    <div class="eui-area">
        <div class="visitorTitle">
            <img src="/Styles/images/xymfImages/cube.png" width="24" alt=""> 活动信息
        </div>
        <form id="activitiesForm" onsubmit="return false;">
            <input type="hidden" th:value="${id}" id="id" name="id"/>
            <div class="eui-bg-white eui-padding20 activity">
                <!--<div class="eui-row eui-paddingB10 eui-borderB eui-marginB20">
                    <div class="eui-col-md6 eui-font16">基本信息</div>
                </div>-->
                <!--基本-->
                <div class="eui-bg-white eui-form">
                    <div class="eui-form-item">
                        <label class="eui-form-label">活动名称</label>
                        <div class="eui-input-inline">
                            <input type="text" name="activityName" placeholder="活动名称" class="eui-input">
                        </div>
                        <label class="eui-form-label">活动目的</label>
                        <div class="eui-input-inline">
                            <input type="text" name="activityAim" placeholder="活动目的" class="eui-input">
                        </div>
                        <label class="eui-form-label">参与方</label>
                        <div class="eui-input-inline">
                            <input type="text" name="participant" placeholder="参与方" class="eui-input">
                        </div>
                    </div>
                    <div data-toggle="distpicker">
                        <div class="eui-form-item">
                            <label class="eui-form-label">活动地点</label>
                            <div id="ld" data-toggle="distpicker">
                                <div class="eui-input-inline">
                                    <select id="province" class="eui-input" e-ignore name="province">

                                    </select>
                                </div>
                                <div class="eui-input-inline">
                                    <select id="city" class="eui-input" e-ignore name="city">

                                    </select>
                                </div>
                                <div class="eui-input-inline">
                                    <select id="district" class="eui-input" e-ignore name="district">

                                    </select>
                                </div>
                            </div>
                            <div class="eui-input-inline">
                                <input type="text" name="activityAddr" placeholder="具体地址" class="eui-input"
                                       style="width: 250px;">
                            </div>
                        </div>
                    </div>
                    <div class="eui-form-item">
                        <label class="eui-form-label">联系人</label>
                        <div class="eui-input-inline">
                            <input type="text" name="contacts" placeholder="联系人" class="eui-input">
                        </div>
                        <label class="eui-form-label">联系电话</label>
                        <div class="eui-input-inline">
                            <input type="text" name="phone" placeholder="联系电话" class="eui-input">
                        </div>
                        <label class="eui-form-label">活动人数</label>
                        <div class="eui-input-inline">
                            <input type="text" name="activityTotal" placeholder="活动人数" class="eui-input">
                        </div>
                    </div>
                    <div class="eui-form-item">
                        <label class="eui-form-label">问卷名称</label>
                        <!--<div class="eui-input-inline">-->
                            <!--<select e-filter="uestionnaireId" name="uestionnaireId">-->

                            <!--</select>-->
                        <!--</div>-->
                        <div class="eui-input-inline">
                            <input type="text" id="uestionnaireId" e-verify="uestionnaireId" autocomplete="off" placeholder="请选择问卷" class="eui-input" readonly="readonly" >
                        </div>
                        <label class="eui-form-label">活动开始时间</label>
                        <div class="eui-input-inline">
                            <input type="text" class="eui-input" readonly="readonly" id="activityStart"
                                   name="activityStart" placeholder="活动开始时间">
                        </div>
                        <label class="eui-form-label">活动结束时间</label>
                        <div class="eui-input-inline">
                            <input type="text" class="eui-input" readonly="readonly" id="activityEnd" name="activityEnd"
                                   placeholder="活动结束时间">
                        </div>
                    </div>
                </div>
            </div>

            <div class="eui-textAlignC eui-bg-white eui-padding20">
            <span onclick="formSub()" class="eui-btn eui-btn-normal eui-btn-big">保存信息</span>
            </div>

            <input type="submit" id="sub" style="display: none;" value="提交"/>
        </form>
    </div>
</div>

<div class="xymfFooter">
    <!-- 底部固定区域 -->
    © 2017 广州市易度软件开发有限公司旗下心云魔方品牌
</div>


<!-- 返回顶部按钮 -->
<span class="eui-icon eui-backTop" e-type="top">&#xe604;</span>

<script src="/Scripts/module/eui.js"></script>
<script type="text/javascript" src="/Scripts/jquery-1.9.0.min.js"></script>
<script src="/Scripts/plugins/distpicker.data.js"></script>
<script src="/Scripts/plugins/distpicker.js"></script>
<script src="/Scripts/plugins/jquery.validate.js"></script>
<script src="/Scripts/date2format.js" type="text/javascript"></script>
<script src="/pack.ajax.js"></script>
<script src="/card.js"></script>
<script>
    var queName = '';
    $(function () {
        eui.use(['form', 'layedit', 'laydate'], function () {
            var form = eui.form
                    , layer = eui.layer
                    , layedit = eui.layedit
                    , laydate = eui.laydate;

            //常规用法
            laydate.render({
                elem: '#activityStart',
                type: 'datetime'
            });
            laydate.render({
                elem: '#activityEnd',
                type: 'datetime'
            });
            //getQuestions(form);//获取问卷名称
            detail(form);
            jQuery.validator.addMethod("isMobile", function (value, element) {
                var length = value.length;
                var mobile = /^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;
                return this.optional(element) || (length == 11 && mobile.test(value));
            }, "请正确填写您的手机号码");
            jQuery.validator.addMethod("isProvincePNo", function(value, element) {
                return this.optional(element) || value!='—— 省 ——';
            }, "请选择省份");
            $("#activitiesForm").validate({
                rules: {
                    activityName: {
                        required: true,
                    },
                    activityAim: {
                        required: true,
                    },
                    participant: {
                        required: true,
                    },
                    phone: {
                        required: true,
                        minlength: 11,
                        isMobile: true
                    },
                    activityAddr: {
                        required: true,
                    },
                    contacts: {
                        required: true,
                    },
                    activityTotal: {
                        required: true,
                        digits: true,
                        min: 1,
                        max: 1000000
                    },
                    activityStart: {
                        required: true,
                    },
                    activityEnd: {
                        required: true,
                    },
                    province :{
                        required: true,
                        isProvincePNo: true
                    }
                },
                messages: {
                    activityName: {
                        required: "请输入活动名称",
                    },
                    activityAim: {
                        required: '请输入活动目的',
                    },
                    participant: {
                        required: '请输入参与方',
                    },
                    phone: {
                        required: '请输入手机号码',
                        minlength: "联系电话不能小于11个字符",
                        isMobile: "请正确填写手机号码"
                    },
                    activityAddr: {
                        required: '请输入地址',
                    },
                    contacts: {
                        required: '请输入联系人',
                    },
                    activityTotal: {
                        required: '请输入活动人数',
                        digits: '只能输入整数',
                        min: '人数必须大于0',
                        max: '人数不能大于100万'
                    },
                    activityStart: {
                        required: '请输入活动开始时间',
                    },
                    activityEnd: {
                        required: '请输入活动结束时间',
                    },
                    province :{
                        required: '请选择省份',
                        isProvincePNo: '请选择省份'
                    }
                },

                submitHandler: function () {
                    var obj = $("#activitiesForm").serializeObject();
                    obj.activityAddr = obj.province + "-" + obj.city + "-" + obj.district + "-" + obj.activityAddr;
                    delete obj.province;
                    delete obj.city;
                    delete obj.district;
                   // obj.uestionnaireName = $('select[name="uestionnaireId"]').find("option:selected").text();
                    obj.uestionnaireName = $('#uestionnaireId').val();
                    /*obj.uestionnaireId = queName;*/
                    console.log(obj);
                    if(obj.activityStart>obj.activityEnd){
                        return layer.msg('活动的开始时间不能大于结束时间');
                    }
                    $.get("/user/questionnaires/list", function (result) {
                        if (result.code = 200) {
                            if (result.data != null) {
                                var total = result.data.questionnairesTotal;
                                if (result.data.member == 1) {//如果是会员
                                    if (new Date() < new Date(result.data.endTime)) {//如果会员还没到期
                                        update(obj);
                                    } else {//会员到期
                                        getTotal(total, obj);
                                    }
                                } else {//不是会员
                                    getTotal(total, obj);
                                }
                            } else {
                                layer.confirm('你的使用卷不足！！', {
                                    btn: ['前往购买', '取消']
                                }, function () {
                                    window.open("/cube/pay/null");
                                })
                            }
                        } else {
                            layer.msg(result.message,{
                                icon: 2,
                                time: 1500
                            })
                        }
                    })
                }
            });
        });
    });

    function getTotal(total,obj) {
        $.post('/launch/activities/getSumTotal', {id:$('#id').val()}, function (result) {
            if (result.code == 200) {
                var sumToatl = parseInt(obj.activityTotal) + parseInt(result.data);
                console.log(parseInt(result.data))
                console.log(sumToatl);
                if (sumToatl > total) {
                    layer.confirm('你的使用卷不足!!', {
                        btn: ['前往购买', '残忍拒绝']
                    }, function () {
                        window.open("/cube/pay/null");
                    })
                } else {
                    update(obj);
                }
            }
        })
    }

    function update(obj) {
        $.post('/launch/activities/update', {launchActivitiesJson: JSON.stringify(obj)}, function (result) {
            console.log(result);
            if (result.code == 200) {
                layer.msg("修改成功",{
                    icon:1,
                    time:1500
                })
                setTimeout(function () {
                    window.close();
                },1500)
            } else {
                layer.msg(result.message);
            }
        });
    }
    function detail(form) {
        $.post("/launch/activities/detail", {id: $('#id').val()}, function (res) {
            if (res.code == 200) {
                var activity = res.data;
                var address = activity.activityAddr;
                var city = address.substring(address.indexOf("-") + 1, find(activity.activityAddr, '-', 1));
                var province = address.substring(0, address.indexOf("-"));
                var district = address.substring(find(activity.activityAddr, '-', 1) + 1, find(activity.activityAddr, '-', 2))
                address = address.substring(find(activity.activityAddr, '-', 2) + 1, address.length);
                $('#province').val(province);
                $('#province').trigger("change");

                $('#city').val(city);
                $('#city').trigger("change");

                $('#district').val(district);
                $('#district').trigger("change");
                $('select[name="district"]').val(district);
                $('input[name="activityName"]').val(activity.activityName);
                $('input[name="activityAim"]').val(activity.activityAim);
                $('input[name="participant"]').val(activity.participant);
                $('input[name="contacts"]').val(activity.contacts);
                $('input[name="phone"]').val(activity.phone);
                $('input[name="activityTotal"]').val(activity.activityTotal);
                $('input[name="activityStart"]').val(new Date(activity.activityStart).Format("yyyy-MM-dd hh:mm:ss"));
                $('input[name="activityEnd"]').val(new Date(activity.activityEnd).Format("yyyy-MM-dd hh:mm:ss"));
                $('input[name="activityAddr"]').val(address);
//                $('select[name="uestionnaireId"]').children().each(function (i, data) {
//                    if (data.value == activity.uestionnaireId) {
//                        return $(this).attr("selected", true);
//                    }
//                })
                $('#uestionnaireId').val(activity.uestionnaireName);
                form.render('select');
            }
        })
    }

    function find(str, cha, num) {
        var x = str.indexOf(cha);
        for (var i = 0; i < num; i++) {
            x = str.indexOf(cha, x + 1);
        }
        return x;
    }
    // 返回顶部
    var winH = $(window).height();

    function formSub() {
        return $("#sub").click();
    }

    $('.eui-backTop').hide();
    $(window).scroll(function (e) {
        var winT = $(window).scrollTop();
        if (winT > winH) {
            $('.eui-backTop').fadeIn()
        } else {
            $('.eui-backTop').fadeOut()
        }
    });

    $('.eui-backTop').click(function (e) {
        $('html,body').animate({scrollTop: 0}, 500)
    });


    /**
     * 获取问卷名称
     * @param form
     */
    function getQuestions(form) {
        $.get("/questionnaire/getQuestionnaireByState", function (result) {
            if (result.code == 200) {
                for (var i in result.data) {
                    var questionnaire = result.data[i];
                    $('select[name="uestionnaireId"]').append('<option value="' + questionnaire.id + '">' + questionnaire.questionnaireName + '</option>')
                }
                form.render('select');
                detail(form);
            }
        })
    }


    /**
     * 加载问卷
     *
     */
    function loadQuestionnaireForAct() {
        var userId=$("[name='visitorId']").val();
        var list=new Array;
        eui.use(['form','layer'], function() { //独立版的layer无需执行这一句
            var $ = eui.jquery,
                layer = eui.layer,form=eui.form; //独立版的layer无需执行这一句
            var iframeWin;//iframe对象
            layer.open({
                type: 2
                ,id: ''
                ,title: '选择问卷'
                ,area: ['800px', '500px']
                ,success: function(layero, index){
                    var body = layer.getChildFrame('body', index);
                    iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：
                }
                ,shade: 0
                ,moveType: 0//拖拽模式，0或者1
                ,maxmin: true
                ,content:"/web/customer/getCheckQuestionnaireForAct"
              //  ,btn: ['确定', '关闭'] //只是为了演示
                ,yes: function(){
//                    var obj =  iframeWin.getQuestionnaireNameAndId();
//                    queName = obj.questionnaireId;
//                    $('#uestionnaireId').val(obj.questionnaireName);
//                    console.log("questionnaireName = " + obj.questionnaireName);
//                    layer.closeAll();
                }
                ,btn2: function(){
                    layer.closeAll();
                },cancel: function(){
                    layer.closeAll();
                }
                ,zIndex: layer.zIndex //重点1
            });
        });

    }
    function setQuestionnaireNameAndId(obj) {
        queName = obj.questionnaireId;
        $('#uestionnaireId').val(obj.questionnaireName);
        console.log("questionnaireName = " + obj.questionnaireName);
        layer.closeAll();
    }
</script>

</body>
</html>
