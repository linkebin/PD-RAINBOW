
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <title>问卷详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/Styles/themes/default/style.css"  media="all">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/Scripts/libs/ztree/css/demo.css" media="all">
    <link rel="stylesheet" href="/Scripts/libs/ztree/css/metroStyle/metroStyle.css" type="text/css">
  <style>

      .eui-icon-rigth{
          font-size: 20px;
          position: absolute;
          right: 15px;
          top: 0;
      }
  </style>
</head>
<body>
<div class="eui-padding15">

    <div>
      <form class="eui-form " action=""  id="formQuestionnaire" >
        <div class="eui-row eui-searchTitle eui-paddingB10 eui-marginB20">
            <div class="eui-col-md6">
                <span class="eui-panels-title1">问卷详情</span>
            </div>
            <div class="eui-col-md6">
                <div class="eui-btn-group eui-panelsIn">
                    <a href="#"  class="eui-btn eui-btn-disabled"  onclick="" disabled="disabled"><i class="eui-icon">&#xe60a;</i> 保存</a>
                </div>
            </div>
        </div>
        <div class="eui-row"   >
            <div class="eui-col-xs6 eui-col-sm6 eui-col-md12"  >

                    <input type="hidden"  name="id"/>
                    <input type="hidden"  name="questionnaireCode"/>
                    <input type="hidden"  name="creator"/>
                    <input type="hidden"  name="createTime" id="createTime"/>
                    <input type="hidden"  name="deleted"/>
                <!--
                    <input type="hidden" id="sceneId" name="sceneId"/>
                    <input type="hidden" id="tagId" name="tagId"/>-->
                    <input type="hidden" id="questionStr" name="questionStr"/>
                <input type="hidden" id="userIds" name="userIds">
                    <div class="eui-form-item">
                        <label class="eui-form-label">名称</label>
                        <div class="eui-input-inline">
                            <input type="text" id="questionnaireName" name="questionnaireName" e-verify="" autocomplete="off" placeholder="请输入名称" class="eui-input eui-btn-disabled" disabled="disabled">
                        </div>

                        <label class="eui-form-label">选择量表</label>
                        <div class="eui-input-inline">
                            <select name="gaugeId" id="gaugeId" e-filter="gaugeId"  e-verify=""  class="eui-btn-disabled" disabled="disabled">
                            </select>
                        </div>

                        <label class="eui-form-label">上架时间</label>
                        <div class="eui-input-inline">
                            <input type="text" class="eui-input eui-btn-disabled" name="shelfTime" id="times" placeholder="请选择时间" disabled="disabled">
                        </div>

                    </div>
                   <div class="eui-form-item">

                         <label class="eui-form-label">问卷类型</label>
                         <div class="eui-input-inline">
                             <select name="questionnaireType" id="questionnaireType" e-verify="gaugeType" class="eui-btn-disabled " disabled="disabled" >
                             </select>
                         </div>

                         <label class="eui-form-label">模板类型</label>
                         <div class="eui-input-inline">
                            <select  e-filter="answerModelType" name="answerModelType" id="answerModelType" e-verify="" class="eui-btn-disabled " disabled="disabled">
                                 <option value="">请选择</option>
                                 <option value="1">横版</option>
                                 <option value="2">竖版</option>
                            </select>
                         </div>
                       <label class="eui-form-label">可见权限</label>
                       <div class="eui-input-inline">
                           <select  e-filter="questionnairePermission" name="questionnairePermission" id="questionnairePermission" e-verify="" class="eui-btn-disabled " disabled="disabled">
                               <option value="">请选择</option>
                               <option value="1">全部</option>
                               <option value="2">指定可见</option>
                           </select>
                       </div>
                      <!-- <label class="eui-form-label">答案正反序</label>-->
                       <div class="eui-input-inline" style="display: none">
                           <input type="radio" id="questionSequence1" name="questionSequence" value="0" title="正" checked>
                           <input type="radio" id="questionSequence2" name="questionSequence" value="1" title="反" >
                        </div>
                        </div>

                <div class="eui-row" id="showUserList" style="display: none;">
                    <label class="eui-form-label">可见权限</label>
                    <div class="eui-form-item">
                        <table class="eui-table eui-form" id="userTable">
                            <colgroup>
                                <col width="180">
                                <col>
                            </colgroup>
                            <thead>
                            <tr>
                                <th>账号</th>
                                <th>用户名称</th>
                                <th>手机号码</th>
                                <th>邮箱</th>
                                <th>地址</th>
                                <th>创建人</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    <div id="pagesUser"></div>
                </div>

                        <div class="eui-form-item">
                            <label class="eui-form-label">问卷说明</label>
                            <div class="eui-input-block">
                                <textarea placeholder="问卷说明"  name="remarks" id="remarks" class="eui-textarea eui-btn-disabled " disabled="disabled"></textarea>
                            </div>
                        </div>
                        <div class="eui-form-item">
                            <label class="eui-form-label">引导语</label>
                            <div class="eui-input-block">
                                <textarea placeholder="引导语"  name="guide" id="guide" class="eui-textarea eui-btn-disabled " disabled="disabled"></textarea>
                            </div>
                        </div>
            </div>
        </div>
      </form>



        <div class="eui-row eui-searchTitle eui-paddingB10 eui-marginB20">
            <div class="eui-col-md6">
                <span class="eui-panels-title2"><i class="eui-icon">&#xe600;</i>标签</span>
            </div>
            <div class="eui-col-md6">
                <div class="eui-btn-group eui-panelsIn">
                    <div class="eui-input-block " style="margin-left: 120px;" >
                        <p  style="margin-left: 0px; width: 120px; height: 36px; margin-top: 3px; line-height: 36px;"   class="eui-btn eui-btn-small eui-btn-disabled " onclick="" disabled="disabled">
                            <i style="font-size: 30px; line-height: 36px;" class="eui-icon">&#xe608;</i>添加标签</p>
                        <!--<button type="button"  id="addMember"  class="eui-btn eui-btn-small" onclick="checkMember()"><i class="eui-icon">&#xe654;</i> 添加成员</button>-->
                    </div>
                </div>
            </div>
        </div>
        <div class="eui-form-item eui-row">
            <div class="eui-col-md12" id="divtag">
                <!--标签-->
            </div>
        </div>

        <div class="eui-row eui-searchTitle eui-paddingB10 eui-marginB20">
            <div class="eui-col-md6">
                <span class="eui-panels-title2"><i class="eui-icon">&#xe62e;</i>场景</span>
            </div>
            <div class="eui-col-md6">
                <div class="eui-btn-group eui-panelsIn">
                    <div class="eui-input-block " style="margin-left: 120px;">
                        <p  style="margin-left: 0px; width: 120px; height: 36px; margin-top: 3px; line-height: 36px;"    class="eui-btn eui-btn-small eui-btn-disabled " onclick="" disabled="disabled">
                            <i style="font-size: 30px; line-height: 36px;" class="eui-icon">&#xe608;</i>添加场景</p>
                        <!--<button type="button"  id="addMember"  class="eui-btn eui-btn-small" onclick="checkMember()"><i class="eui-icon">&#xe654;</i> 添加成员</button>-->
                    </div>
                </div>
            </div>
        </div>
        <div class="eui-form-item eui-row">
            <div class="eui-col-md12" id="divscene">
                <!--场景-->
            </div>
        </div>




        <div class="eui-row eui-searchTitle eui-paddingB10 eui-marginB20" name="transverse">
            <div class="eui-col-md6" >
                <span class="eui-panels-title2"><i class="eui-icon">&#xe60a;</i>可选的问题</span>
            </div>
            <div class="eui-col-md6">
                <div class="eui-btn-group eui-panelsIn">
                    <button class="eui-btn eui-btn-disabled " onclick="chageQuestion()" disabled="disabled"><i class="eui-icon">&#xe610;</i> 选择</button>
                </div>
            </div>
        </div>
        <div class="eui-row"   name="transverse">
            <div class="eui-col-xs6 eui-col-sm6 eui-col-md12"  >
                <form class="eui-form " id="searchFrom" action=""   >
                    <blockquote class="eui-elem-quote eui-quote-search">
                        <input type="hidden" id="id" name="id"/>
                        <input type="hidden"  name="ascriptionType" value="1"/>
                        <div class="eui-input-inline eui-padding10">
                            <input type="text" name="questionCode" e-verify="title" value="" autocomplete="off" placeholder="编号" class="eui-input">
                        </div>
                        <div class="eui-input-inline eui-padding10">
                            <input type="text" name="questionContent" e-verify="title" value="" autocomplete="off" placeholder="问题内容" class="eui-input">
                        </div>
                        <div class="eui-input-inline eui-padding10">
                            <select name="questionType">
                                <option value="" >答案类型</option>
                                <option value="1" >单选</option>
                                <option value="2" >多选</option>
                                <option value="3" >评分单选</option>
                            </select>
                        </div>
                        <div class="eui-input-inline">
                            <span class="eui-btn" onclick="doSearch()">查询</span>
                            <span class="eui-btn eui-btn-primary" onclick="resetForm()" >重置</span>
                        </div>
                    </blockquote>
                    <div class="eui-form-item">
                        <table class="eui-table eui-form" id="questionTable">
                            <colgroup>
                                <col width="60">
                                <col>
                            </colgroup>
                            <thead>
                            <tr>
                                <th><input type="checkbox" name="" title="" e-filter="allChoose" e-skin="primary"></th>
                                <th>问题编号</th>
                                <th>问题内容</th>
                                <th>选项</th>
                                <th>答案对应分数</th>
                                <th>答案</th>
                                <th>答案类型</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                        <div id="pages"></div>
                    </div>
                </form>
            </div>

        </div>

        <div class="eui-row eui-searchTitle eui-paddingB10 eui-marginB20">
            <div class="eui-col-md6">
                <span class="eui-panels-title2"><i class="eui-icon">&#xe60a;</i>已选的问题</span>
            </div>
            <div class="eui-col-md6">
                <div class="eui-btn-group eui-panelsIn">
                    <div class="eui-input-block " style="margin-left: 120px;">
                       <!-- <p  style="margin-left: 0px; width: 120px; height: 36px; margin-top: 3px; line-height: 36px;"    class="eui-btn eui-btn-small" onclick="addQuestion()">
                            <i style="font-size: 30px; line-height: 36px;" class="eui-icon">&#xe608;</i>自定义问题</p>-->
                        <!--<button type="button"  id="addMember"  class="eui-btn eui-btn-small" onclick="checkMember()"><i class="eui-icon">&#xe654;</i> 添加成员</button>-->
                    </div>
                </div>
            </div>
        </div>
        <div class="eui-collapse" e-filter="test" >
            <div class="eui-colla-item">
                <h2 class="eui-colla-title">选择量表的问题</h2>
                <div class="eui-colla-content eui-show" id="questionCollapse">
                    <!--  这里放选择的量表问题-->
                </div>
            </div>
            <div class="eui-colla-item">
                <h2 class="eui-colla-title" name="transverse">新增的问题</h2>
                <div class="eui-colla-content" id="addQuestionCollapse">
                    <!--这里放新添加的问题-->
                </div>
            </div>
        </div>
    </div>
</div>

<!--添加问题的界面-->
<form class="eui-form eui-marginL10 eui-paddingL10 eui-marginT10 eui-paddingR10 eui-form-pane" id="questionForm"  style="display: none">
    <input  type="hidden" name="id"/>
    <input  type="hidden" name="createTime"/>
    <input  type="hidden" name="creator"/>
    <input  type="hidden" name="deleted"/>
    <input  type="hidden" name="questionCode"/>
    <div class="eui-form-item" style="width: 700px">
        <div class="eui-form-item eui-form-text" >
            <label class="eui-form-label">问题内容 </label>
            <div class="eui-input-block">
                <textarea name="questionContent" placeholder="请输入内容" class="eui-textarea"></textarea>
            </div>
        </div>
    </div>
    <div class="eui-form-item" style="width: 700px">
        <div class="eui-form-item eui-form-text">
            <label class="eui-form-label">选项</label>
            <div class="eui-input-block">
                <textarea name="optionAnswer"  placeholder="例:A:一般||B:好||C:非常好" class="eui-textarea"></textarea>
            </div>
        </div>
    </div>
    <div class="eui-form-item"  style="width: 700px">
        <div class="eui-form-item eui-form-text">
            <label class="eui-form-label">选项对应分数</label>
            <div class="eui-input-block">
                <textarea name="optionScore" placeholder="例:10||20||30" class="eui-textarea"></textarea>
            </div>
        </div>
    </div>
    <div class="eui-form-item"  style="width: 700px">

        <label class="eui-form-label">答案顺序</label>
        <div class="eui-input-inline" >
            <input type="radio" id="answerSequence1" name="answerSequence" value="1" title="正" checked>
            <input type="radio" id="answerSequence2" name="answerSequence" value="2" title="反" >
        </div>

        <label class="eui-form-label">答案类型</label>
        <div class="eui-input-inline">
            <select name="questionType" e-filter="questionType">
                <option value="0" >请选择类型</option>
                <option value="1" >单选</option>
                <option value="2" >多选</option>
                <option value="3" >评分单选</option>
            </select>
        </div>
        <label name="answer1" class="eui-form-label">答案</label>
        <div class="eui-input-inline" name="answer1">
            <input type="text" name="answer" required placeholder="例:A:一般||B:好" autocomplete="off" class="eui-input">
        </div>
    </div>
</form>
<!--添加问题的界面end-->






<script src="/Scripts/module/eui.js" charset="utf-8"></script>
<script src="/Scripts/main.js" charset="utf-8"></script>
<script type="text/javascript" src="/Scripts/jquery-1.9.0.min.js"></script>
<script src="/Scripts/libs/ligerUI/js/ligerui.all.js" type="text/javascript"></script>
<script src="/pack.ajax.js" charset="utf-8"></script>
<script src="/date2format.js" charset="utf-8"></script>
<script src="/Scripts/plugins/md5/md5.min.js" type="text/javascript"></script>
<script src="/Scripts/plugins/jquery.validate.js"></script>



<script>
//手风琴折叠
    eui.use(['element', 'layer'], function(){
        var element = eui.element;
        var layer = eui.layer;

        //监听折叠
        element.on('collapse(test)', function(data){
            //layer.msg('展开状态：'+ data.show);
        });
    });



// 表单
eui.use(['form', 'layedit', 'laydate','laypage', 'layer'], function(){
    var form = eui.form
    ,layer = eui.layer
    ,layedit = eui.layedit
    ,laydate = eui.laydate
    ,laypage = eui.laypage;


    //问题类型
    form.on('select(questionType)', function(data){
        if(data.elem.value!='3' && data.elem.value!='0'){
            $("[name='answer1']").show();
        }else {
            $("[name='answer1']").hide();
            $("#questionForm [name='answer']").val("");
        }
    });

    //全选
    form.on('checkbox(allChoose)', function(data){
        var child = $(data.elem).parents('table').find('tbody input[type="checkbox"]');
        child.each(function(index, item){
            item.checked = data.elem.checked;
        });
        form.render('checkbox');
    });

    //监听提交
    form.on('submit(demo)', function(data){
        layer.alert(JSON.stringify(data.field), {
            title: '最终的提交信息'
        });
        return false;
    });


    //前后若干天可选，这里以1天为例
    laydate.render({
        elem: '#times'
        ,min: 1
    });

    //日期范围
    laydate.render({
        elem: '#test6'
        ,range: true
    });
    //select 的选择监听事件
    form.on('select(gaugeId)', function(data){

        //删除原来的所有问题
        $("#questionCollapse").children().remove();
        $("#addQuestionCollapse").children().remove();
        checkGauge(data.value);
    });

    //模板类型
    form.on('select(answerModelType)', function(data){
        if(data.elem.value=='1'){
            $("[name='transverse']").hide();
            var questionList= $("#addQuestionCollapse").children();
            for(var i=0;i< questionList.length;i++ ){
                deleteQuestion( questionList.eq(i).attr("question"));
            }
        }else if(data.elem.value=='2'){
            $("[name='transverse']").show();
        }
    });

    //问卷权限
    form.on('select(questionnairePermission)', function(data){
        if(data.elem.value=='1'){
            $('#showUserList').hide();
        }
        if(data.elem.value=='2'){
            //弹出咨询师列表
            loadUserList();
            //showUserList();
        }
    });
});



</script>

<script th:inline="javascript">
    //初始化数据
  var questionnaireQuestionFactorList=[[${questionnaireQuestionFactorList}]];
  //新加问题的id
  var newQuestion=[[${newQuestion}]];
  //有选择量表的id
  var gaugeQuestionIds=[[${gaugeQuestionIds}]];

  var questionnaireTagList=[[${questionnaireTagList}]];
  var sceneList=[[${sceneList}]];
  var questionnaires=[[${questionnaire}]];

  var questionnaireId=questionnaires.id;
    console.info("数据");
    console.info(questionnaireQuestionFactorList);
    console.info(questionnaireTagList);
    console.info(sceneList);
    console.info(questionnaires);

    $(function () {
        doSearch();
        loadGauge ();
        //答案隐藏
        $("[name='answer1']").hide();
    });

    //咨询师列表
    function loadUserList(){
        var list=new Array;
        eui.use(['form','layer'], function() { //独立版的layer无需执行这一句
            var $ = eui.jquery,
                layer = eui.layer,form=eui.form; //独立版的layer无需执行这一句
            var iframeWin;//iframe对象
            layer.open({
                type: 2
                ,title: '指定权限'
                ,area: ['800px', '500px']
                ,shade: 0
                ,moveType: 0//拖拽模式，0或者1
                ,maxmin: true
                ,content:"/web/questionnairePermissionMiddle/findQuestionnaireSecUser"
                ,btn: ['确定', '关闭']
                ,yes: function(){
                    //得到设置返回的结果
                    list=iframeWin.getCheckTag();
                    //merge("tag",list)
                    console.log("id = " + list[0].id);
                    getUserList(list);
                    layer.closeAll();

                }
                ,btn2: function(){
                    layer.closeAll();
                }
                ,zIndex: layer.zIndex //重点1
                ,success: function(layero, index){
                    layer.setTop(layero); //重点2
                    var body = layer.getChildFrame('body', index);
                    iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：
                    //  body.find('input').val('Hi，我是从父页来的')
                }


            });


        });

    }

    //获取指定id的咨询师
    function getUserList(list) {
        var ids = '';
        for(var i in list){
            ids += list[i].id + ',';
        }
        $('#userIds').val(ids);
        eui.use(['form','laypage','layer'], function(){
            var form = eui.form
                ,laypage = eui.laypage
                ,layer = eui.layer,
                $ = eui.jquery;

            //加载层
            var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
            $.ajax({
                url:"/questionnairePermissionMiddle/findQuestionnaireSecUserByIds",
                data: {
                    ids:ids,
                    page:1,
                    size:10
                },
                type:"post",
                success:function(result){
                    //当你在iframe页面关闭自身时
                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                    parent.layer.close(index); //再执行关闭
                    // 分页
                    laypage.render({
                        elem: 'pagesUser'
                        ,count: result.data.total
                        ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        ,skip: true
                        ,jump: function(obj,first){
                            if (first){
                                //第一次，不需要查询数据
                                var userList = result.data.list;
                                //遍历，拼接表格
                                var tableHtml = getUserTable(userList);
                                $("#userTable tbody").html(tableHtml);
                                form.render('checkbox');
                            }else {
                                //加载层
                                var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
                                $.ajax({
                                    url: "/questionnairePermissionMiddle/findQuestionnaireSecUserByIds",
                                    data: {
                                        ids: ids,
                                        page: obj.curr,
                                        size: obj.limit
                                    },
                                    type: "post",
                                    success: function (result) {
                                        //当你在iframe页面关闭自身时
                                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                        parent.layer.close(index); //再执行关闭
                                        var userList = result.data.list;
                                        //遍历，拼接表格
                                        var tableHtml = getUserTable(userList);
                                        $("#userTable tbody").html(tableHtml);
                                        //重新加载复选框
                                        form.render('checkbox');
                                    }
                                });
                            }
                        }
                    });
                }
            });

        });

    }

    //拼接咨询师列表
    function getUserTable(userList) {
        $('#showUserList').show();
        var tableHtml = '';
        for (var item in userList){
            var user=userList[item];
            tableHtml +=  '<tr>' +
                '<td id=userAccount '+user.id+'>'+ user.account +'</td>' +
                '<td id=userUserName '+user.id+'>'+ user.userName +'</td>' +
                '<td id=userMobile '+user.id+'>'+ user.mobile +'</td>' +
                '<td id=userEmail '+user.id+'>'+ user.email +'</td>' +
                '<td id=userAddr '+user.id+'>'+ user.addr +'</td>' +
                '<td id=userCreator '+user.id+'>'+ user.creator +'</td>' +
                '</tr>';
        }

        return tableHtml;
    }

    //定义一个装id的数组
   var idArray="";
    //加载数据
    function doSearch() {
        eui.use(['form','laypage','layer'], function(){
            var form = eui.form
                ,laypage = eui.laypage
                ,layer = eui.layer,
                $ = eui.jquery;
            //数据给id
            $("#id").val(idArray);
            var params = $("#searchFrom").serializeObject();
            //加载层
            var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
            $.ajax({
                url:"/questionnaire/question/findQuestionBYid",
                data: {
                    params:JSON.stringify(params),
                    page:1,
                    size:10
                },
                type:"post",
                success:function(result){
                    layer.closeAll();
                    // 分页
                    laypage.render({
                        elem: 'pages'
                        ,count: result.data.total
                        ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        ,skip: true
                        ,jump: function(obj,first){
                            if (first){
                                //第一次，不需要查询数据
                                var questionList = result.data.list;
                                //遍历，拼接表格
                                var tableHtml = getTable(questionList);
                                $("#questionTable tbody").html(tableHtml);
                                form.render('checkbox');
                            }else {
                                var params = $("#searchFrom").serializeObject();
                                //加载层
                                var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
                                $.ajax({
                                    url: "/questionnaire/question/questionListByPage",
                                    data: {
                                        params: JSON.stringify(params),
                                        page: obj.curr,
                                        size: obj.limit
                                    },
                                    type: "post",
                                    success: function (result) {
                                        layer.closeAll();
                                        var questionList = result.data.list;
                                        //遍历，拼接表格
                                        var tableHtml = getTable(questionList);
                                        $("#questionTable tbody").html(tableHtml);
                                        //重新加载复选框
                                        form.render('checkbox');
                                    }
                                });
                            }
                        }
                    });
                }
            });

        });
    }

    //渲染数据，拼接表格
    function getTable(questionList) {
        var tableHtml = '';

             for (var item in questionList){
            var question=questionList[item];
                 var  questionType="";
                 if(question.questionType=='1'){
                     questionType="单选";
                 }else if(question.questionType=='2'){
                     questionType="多选";
                 }else {
                     questionType="评分单选";
                 }
            tableHtml +=  '<tr>' +
                '<td><input name="" e-skin="primary" class="mycheckbox" type="checkbox"><input name="questionId" type="hidden" value="' + question.id + '"></td>' +
                '<td>'+ question.questionCode +'</td>' +
                '<td>'+ question.questionContent +'</td>' +
                '<td>'+ question.optionAnswer +'</td>'   +
                '<td>'+ question.optionScore +'</td>' +
                '<td>'+ question.answer +'</td>' +
                '<td>'+ questionType +'</td>' +
                '</tr>';
        }

        return tableHtml;
    }

    //删除问题
    function deleteQuestion(id){
        var ids='div'+id;
        //替换掉idArray 里面存在的ida
        idArray=idArray.replace(id+",","");
        idArray=idArray.replace(","+id,"");
        idArray=idArray.replace(id,"");
        $("#"+ids).remove();
        doSearch();
        spanSequence();
    }
    //选择问题
    function chageQuestion() {
    eui.use(['form','laypage','layer'], function(){
        var form = eui.form
            ,elem=eui.elem
            ,laypage = eui.laypage
            ,layer = eui.layer,
            $ = eui.jquery;
        var ids="";
        idArray+=",";
        if (ids==''){
            $(".mycheckbox:checked").each(function(i){
                var id = $(this).parent().find("input[name='questionId']").val();
                ids += id + ',';
                idArray+=id+","
            });
        }

        if (ids==''){
            layer.msg('请选择问题', {
                time: 2000
            });
            return ;
        }
        var item=idArray.substring(0,1);
        if(item==','){
            idArray=idArray.substring(1,idArray.length-1);
        }else {
            idArray=idArray.substring(0,idArray.length-1);
        }

        doSearch();
        //加载层
        var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
        $.post("/questionnaire/question/findQuestion",{"ids":ids},function (result) {
                layer.closeAll();
            var context= questionList(result.data,"show");
            $("#addQuestionCollapse").append(context);
            spanSequence();
        });
      });
    }

    //拼接问题列表
    function  questionList(questionList,type){
        //type show选择的问题能删除   hide选择的量表不能删除
        var context="";
        for(var item in questionList){
         var  question=  questionList[item];
             context+='<div name="questionIds"  question="'+question.id+'" id="div'+question.id+'" class="eui-colla-item ">';
             context+='  <h2  class="eui-colla-title"><span name="spanNumber"></span>'+question.questionContent;
            if(type=='show'){
               context+='  <i  title="删除" onclick="" class="eui-icon eui-icon-rigth eui-btn-disabled" disabled="disabled">&#xe640;</i> ';
             }
             context+='  </h2> ';
             context+=' <div class="eui-colla-content eui-show"> ';
             var optionScore=question.optionScore+"";
             var  optionAnswer=question.optionAnswer+"";
             var optionScoreArray=optionScore.split("||");
             var optionAnswerArray=optionAnswer.split("||");
            context+='   <p> ';
             for(var i=0;i<optionAnswerArray.length;i++){
                 context+=optionAnswerArray[i]+"("+optionScoreArray[i]+"分)";
             }
             context+=' <p>答案：'+question.answer+'  </p> ';
             context+='   </p> ';
             context+='  </div>  ';
             context+='</div>  ';
        }
     return context;
    }

    //量表类型加载
    function  loadGaugeType () {
       $.post("/questionnaire/type/typeTree",{},function(result){
           var context="";
           var list=result.data;
               context+=" <option value=''>请选择类型</option>";
           for( var i in  list){
               context+="<option value='"+list[i].id+"'>"+list[i].name+" </option>";
           }
           $("#questionnaireType").html(context);
           //更新
           formRender();
           update();
       });

    }

    //量表模板加载
    function  loadGauge () {
        $.post("/gauge/findGaugeAll",{},function(result){
            var context="";
            var list=result.data;
            context+=" <option value=''>请选择</option>";
            for( var i in  list){
                if(list[i].gaugeState==0){
                  context+="<option value='"+list[i].id+"'>"+list[i].gaugeName+" </option>";
                }
            }
            $("#gaugeId").html(context);
            //更新
            formRender();
            loadGaugeType ();
        });

    }

    //保存问卷
     function saveGauge(){
         var questionId=document.getElementsByName("questionIds");
         var questionArray=new Array();
         for(var i=0;i<questionId.length;i++){
             var ids=questionId[i].id;
             questionArray[i]=$("#"+ids).attr("question");
         }
         var questionStr=questionArray.join(",");
         $("#questionStr").val(questionStr);

       //验证
       if($("#questionnaireName").val()==""){
           layer.msg('请填写名称', {
               time: 2000
           });
           return;
       }else if($("#times").val()==""){
           layer.msg('请选择上架时间', {
               time: 2000
           });
           return;
       }else if($("#questionStr").val()==""){
           layer.msg('请选择问题', {
               time: 2000
           });

           return;
       }else if($("#questionStr").val()==""){
           layer.msg('请选择问题', {
               time: 2000
           });

           return;
       }else if($("#answerModelType").val()==""){
           layer.msg('请选择模板类型', {
               time: 2000
           });
           return;
       }else if($('#questionnairePermission').val() == ''){
           layer.msg('请指定可见权限',{
               time: 2000
           });
           return;
       }
       //给标签设置值
       //  $("#tagId").val(getTagOrSceneId("tag"));
       //给场景设置值
       //  $("#sceneId").val(getTagOrSceneId("scene"));

         var formQuestionnaire=$("#formQuestionnaire").serialize();
         //加载层
         var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
        $.post("/questionnaire/updateQuestionnaire",formQuestionnaire,function (result) {
            if(result.code==200){
                layer.closeAll();
                layer.msg('添加成功', {
                    time: 2000
                });
                    window.close();
                    window.opener.location.href=window.opener.location.href;

            }else {
                layer.msg('添加失败', {
                    time: 2000
                });
            }
        });
     }

     //  量表的标签加载 并返回选择的标签
     function  loadTag() {
         var list=new Array;
         eui.use(['form','layer'], function() { //独立版的layer无需执行这一句
             var $ = eui.jquery,
                 layer = eui.layer,form=eui.form; //独立版的layer无需执行这一句
             var iframeWin;//iframe对象
             layer.open({
                 type: 2
                 ,id: 'checkTag'
                 ,title: '选择标签'
                 ,area: ['800px', '500px']
                 ,success: function(layero, index){

                         var body = layer.getChildFrame('body', index);
                         iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：
                       //  body.find('input').val('Hi，我是从父页来的')
                     }
                 ,shade: 0
                 ,moveType: 0//拖拽模式，0或者1
                 ,maxmin: true
                 ,content:"/web/gauge/getGaugeTag"
                 ,btn: ['确定', '关闭'] //只是为了演示
                 ,yes: function(){
                     layer.closeAll();
                   //得到设置返回的结果
                     list=iframeWin.getCheckTag();
                     merge("tag",list,1)
                 }
                 ,btn2: function(){
                     layer.closeAll();
                 }
                 ,zIndex: layer.zIndex //重点1
             });
         });

     }

     //  量表的场景加载 并返回选择的场景
     function  loadScene() {
        var list=new Array;
        eui.use(['form','layer'], function() { //独立版的layer无需执行这一句
            var $ = eui.jquery,
                layer = eui.layer,form=eui.form; //独立版的layer无需执行这一句
            var iframeWin;//iframe对象
            layer.open({
                type: 2
                ,id: 'checkScene'
                ,title: '选择场景'
                ,area: ['800px', '500px']
                ,success: function(layero, index){

                    var body = layer.getChildFrame('body', index);
                    iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：
                    //  body.find('input').val('Hi，我是从父页来的')
                }
                ,shade: 0
                ,moveType: 0//拖拽模式，0或者1
                ,maxmin: true
                ,content:"/web/gauge/getGaugeScene"
                ,btn: ['确定', '关闭'] //只是为了演示
                ,yes: function(){
                    layer.closeAll();
                    //得到设置返回的结果
                    list=iframeWin.getCheckScene();
                    merge("scene",list,1)
                }
                ,btn2: function(){
                    layer.closeAll();
                }
                ,zIndex: layer.zIndex //重点1
            });
        });

    }

     //拼接标签 或者 场景
     function  merge(type,list,state){
         // state 状态  数据加载是0  添加1
         var context="";
         var url="";
         if(type=='tag' ){
             url=  "/questionnaire/tag/middle/addQuestionnaireTagMiddle";
         }else {
             url=  "/questionnaire/scene/addQuestionnaireScene";
         }

         var context="";
         //得到所有的成员
         var typeAll= $("[name='"+type+"']");
         if(typeAll.length==0 && state==0){
             for(var i=0;i<list.length;i++){
                 context+=  '<span id="'+type+list[i].id+'" name="'+type+'" style="width: 120px; margin: 0px 5px 5px 0px;" ' +
                     'class="eui-btn eui-btn-primary eui-btn-disabled" '+type+'Id='+list[i].id+'>'+list[i].name+' <i  onclick="" class="eui-icon" name="'+type+'">&#x1006;</i></span>';
             }
         }else {
        //去掉重复的 标签或者场景
        for(var i=0;i<list.length;i++){
            var stast=0;
            for(var j=0;j<typeAll.length;j++){
                var typeId = typeAll.eq(j).attr(type+"Id");
                if(list[i].id==typeId){
                    stast++;
                }
            }
            if(stast==0){
                context+=  '<span id="'+type+list[i].id+'" name="'+type+'" style="width: 120px; margin: 0px 5px 5px 0px;" ' +
                    'class="eui-btn eui-btn-primary eui-btn-disabled" '+type+'Id='+list[i].id+'>'+list[i].name+' <i  onclick="" class="eui-icon" name="'+type+'">&#x1006;</i></span>';
                //添加
                var  ids=list[i].id;
                //加载层
                var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
                $.post(url,{"ids":ids,"questionnaireId":questionnaireId},function (result) {
                    layer.closeAll();
                    if(result.code==200){
                        layer.msg('添加成功', {
                            time: 2000
                        });
                    }else {
                        layer.msg('添加失败', {
                            time: 2000
                        });
                    }
                });

            }else{
                stast=0;
            }
        }
    }
         $("#div"+type).before(context);

     }
     //删除场景  或者标签
     function deleteTagOrScene(type,id){

       $("#"+type+id).remove();
         //加载层
         var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
         var url="";
         if(type=='tag'){
             url=  "/questionnaire/tag/middle/deleteQuestionnaireTagMiddle";
         }else {
             url=  "/questionnaire/scene/deleteQuestionnaireScene";
         }
         $.post(url,{"ids":id,"questionnaireId":questionnaireId},function (result) {
             layer.closeAll();
             if(result.code==200){
                 layer.msg('删除成功', {
                     time: 2000
                 });
             }else {
                 layer.msg('删除失败', {
                     time: 2000
                 });
             }
         });

  }

    //获得场景 或者标签的id 1,2,3
     function getTagOrSceneId(type){
        var spanNmae= $("[name='"+type+"']");
        var list=new Array();
        for(var i=0;i<spanNmae.length;i++){
            list[i]=spanNmae.eq(i).attr(type+"Id");

        };
        return list.join(",");
    }

    //选择量表 则查询出相关的 标签  场景
     function checkGauge(gaugeId){
         if(gaugeId==''){
             idArray="";
             doSearch();
             $("#questionCollapse").children().remove();

         }else {
          $.post("/gauge/getGaugeInfo",{"gaugeId":gaugeId},function (result) {
              console.info("result");
              console.info(result);
             // gauge gaugeQuestionList questionnaireTagList sceneList
              //量表的信息填充
              var gauge=result.data.gauge;
              $("#questionnaireName").val(gauge.gaugeName);
              $("#questionnaireType").val(gauge.gaugeType);
              formRender();

              //问题的的信息填充
              var questions=result.data.gaugeQuestionList;
              var texts="";
              for(var i=0;i<questions.length;i++){
                  texts+=questions[i].questionId+",";
              }
              texts=texts.substring(0,texts.length-1);
              $("#questionStr").val(texts);
              var questionnaireTagList=result.data.questionnaireTagList;
              var sceneList=result.data.sceneList;
              initializeQuestion(questions,questionnaireTagList,sceneList,1)
          });
         }
   }

     //初始化选择的量表
     function  initializeQuestion(questions,questionnaireTagList,sceneList,type) {
        eui.use(['form','laypage','layer'], function(){
            var form = eui.form
                ,elem=eui.elem
                ,laypage = eui.laypage
                ,layer = eui.layer,
                $ = eui.jquery;

            //标签
            var tagList=new Array;
            for(var i in  questionnaireTagList){
                var obj=new Object();
                obj.id=questionnaireTagList[i].id;
                obj.name=questionnaireTagList[i].tagName;
                tagList.push(obj);
            }
            merge("tag",tagList,0);
            //场景
            var scenes=new Array;
            for(var i in  sceneList){
                var obj=new Object();
                obj.id=sceneList[i].id;
                obj.name=sceneList[i].sceneName;
                scenes.push(obj);
            }
            merge("scene",scenes,0);

            //问题
            var ids="";
            idArray=",";
            for(var i in  questions){
                ids += questions[i].questionId+ ',';
                idArray+=questions[i].questionId +","
            }
            var item=idArray.substring(0,1);
            if(item==','){
                idArray=idArray.substring(1,idArray.length-1);
            }else {
                idArray=idArray.substring(0,idArray.length-1);
            }
            doSearch();
            if(type==0){
                ids="";
                for(var i in  gaugeQuestionIds){
                    ids += gaugeQuestionIds[i]+ ',';
                }
                var ids1="";
                for(var i in  newQuestion){
                    ids1 += newQuestion[i]+ ',';
                }
                //新增加的问题
                findQuestion(ids1,'show');
            }
                //量表的里的问题 不能删除
                findQuestion(ids,'hide');
        });
    }

    //通过问题id 查询问题  填充已选择的问题
    function findQuestion(ids,type){
        //加载层
        var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
        $.post("/questionnaire/question/findQuestion",{"ids":ids},function (result) {
            layer.closeAll();
           // var context= questionList(result.data,"hide");
            var context= questionList(result.data,type);
            if(type=='hide'){
              $("#questionCollapse").append(context);
            }else {
                $("#addQuestionCollapse").append(context);
            }
            spanSequence();
        });
    }

     //修改的前加载数据
     function  update() {
        $("#formQuestionnaire [name='questionnaireName']").val(questionnaires.questionnaireName);
        $("#formQuestionnaire [name='gaugeId']").val(questionnaires.gaugeId);
        $("#formQuestionnaire [name='id']").val(questionnaires.id);
        $("#formQuestionnaire [name='questionnaireCode']").val(questionnaires.questionnaireCode);
        $("#formQuestionnaire [name='creator']").val(questionnaires.creator);
        $("#formQuestionnaire [name='createTime']").val(format(questionnaires.createTime));
        $("#formQuestionnaire [name='deleted']").val(questionnaires.deleted);
        if(questionnaires.questionSequence==0){
            $("#questionSequence1").attr("checked","checked");
            $("#questionSequence2").removeAttr("checked");
        }else {
            $("#questionSequence2").attr("checked","checked");
            $("#questionSequence1").removeAttr("checked");
        }
         $("#formQuestionnaire [name='shelfTime']").val(format(questionnaires.shelfTime));
         $("#formQuestionnaire [name='questionnaireType']").val(questionnaires.questionnaireType);
         $("#formQuestionnaire [name='answerModelType']").val(questionnaires.answerModelType);
         $("#formQuestionnaire [name='remarks']").val(questionnaires.remarks);
         $("#formQuestionnaire [name='guide']").val(questionnaires.guide);
         if (questionnaires.questionnairePermission == 1){
             $("#formQuestionnaire [name='questionnairePermission']").val(questionnaires.questionnairePermission);
         }else if(questionnaires.questionnairePermission == 2){
             $('#questionnairePermission').val(questionnaires.questionnairePermission);
             //根据问卷id查找指定咨询师
             findSecUserByQuestionnaireId(questionnaires.id);
         }
         formRender();
        var texts="";
        for(var i=0;i<questionnaireQuestionFactorList.length;i++){
            texts+=questionnaireQuestionFactorList[i].questionId+",";
        }
        texts=texts.substring(0,texts.length-1);
        $("#questionStr").val(texts);

        initializeQuestion(questionnaireQuestionFactorList,questionnaireTagList,sceneList,0);
         if(questionnaires.answerModelType=='1'){
             $("[name='transverse']").hide();
             $("#addQuestionCollapse").children().remove();
         }else if(questionnaires.answerModelType=='2'){
             $("[name='transverse']").show();

         }
    }

    //字符串转日期格式，strDate要转为日期格式的字符串
    function getDate(strDate){
        var date = eval('new Date(' + strDate.replace(/\d+(?=-[^-]+$)/,
                function (a) { return parseInt(a, 10) - 1; }).match(/\d+/g) + ')');
        return date;
    }

    //根据问卷id查找指定咨询师
    function findSecUserByQuestionnaireId(questionnaireId){
        eui.use(['form','laypage','layer'], function() {
            var form = eui.form
                , laypage = eui.laypage
                , layer = eui.layer,
                $ = eui.jquery;
//加载层
            var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
            $.ajax({
                url: "/questionnairePermissionMiddle/findSecUserByQuestionnaireId",
                data: {
                    questionnaireId: questionnaireId,
                    page: 1,
                    size: 10
                },
                type: "post",
                success: function (result) {
                    //当你在iframe页面关闭自身时
                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                    parent.layer.close(index); //再执行关闭
                    // 分页
                    laypage.render({
                        elem: 'pagesUser'
                        , count: result.data.total
                        , layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        , skip: true
                        , jump: function (obj, first) {
                            if (first) {
                                //第一次，不需要查询数据
                                var userList = result.data.list;
                                console.log(userList + "=====----====");
                                //遍历，拼接表格
                                var tableHtml = getUserTable(userList);
                                $("#userTable tbody").html(tableHtml);
                                form.render('checkbox');
                            } else {
                                //加载层
                                var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
                                $.ajax({
                                    url: "/questionnairePermissionMiddle/findSecUserByQuestionnaireId",
                                    data: {
                                        ids: ids,
                                        page: obj.curr,
                                        size: obj.limit
                                    },
                                    type: "post",
                                    success: function (result) {
                                        //当你在iframe页面关闭自身时
                                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                        parent.layer.close(index); //再执行关闭
                                        var userList = result.data.list;
                                        //遍历，拼接表格
                                        var tableHtml = getUserTable(userList);
                                        $("#userTable tbody").html(tableHtml);
                                        //重新加载复选框
                                        form.render('checkbox');
                                    }
                                });
                            }
                        }
                    });
                }
            });
        });
    }



    //自定义添加问题
    function addQuestion() {
        var uri='/web/questionnaire/getAddQuestion?flg=0&ids='+0+'&ascriptionType=1';
        eui.use('layer', function(){ //独立版的layer无需执行这一句
            var $ = eui.jquery, layer = eui.layer,form=eui.form;
            layer.open({
                type: 2
                ,title: '添加问题'
                ,content: uri
                ,area: ['900px', '600px']
                ,btnAlign: 'c'
                ,shade: 0
                ,moveType: 0//拖拽模式，0或者1
                ,maxmin: true
                ,success: function(layero){
                    //layer.setTop(layero); //重点2
                }
                ,cancel: function(){
                    //右上角关闭回调
                    resetAddOrUpdateForm();
                }
            });

        });

    }

    //子页面调用父页面的方法
    function  whetherSuccess(type,question) {
        eui.use('layer', function(){ //独立版的layer无需执行这一句
            var $ = eui.jquery, layer = eui.layer,form=eui.form;
            layer.closeAll();
            if(type=='success'){
                var array=new Array;
                array[0]=question;
                var context= questionList(array,"show");
                $("#addQuestionCollapse").append(context);
                idArray+=","+question.id;
                spanSequence();
                layer.msg('操作成功', {
                    time: 2000
                });
            }else {
                layer.msg('操作失败', {
                    time: 2000
                });
            }
        });
    }

    //添加修改form表单修改
    function resetAddOrUpdateForm() {
        $("#questionForm [name='id']").val("");
        document.getElementById('questionForm').reset();
    }
    //对问题的排序
    function  spanSequence() {
        var spanNumber=  $("[name='spanNumber']");
        for(var i=0;i<spanNumber.length;i++){
            spanNumber.eq(i).text(i+1+".");
        }
    }

    //form表单  select,checkbox,radio 动态添加  需要更新
     function   formRender() {
         eui.use(['form'], function(){
             var form = eui.form;
             form.render();
         });
     }
    //重置
    function resetForm() {
        document.getElementById('searchFrom').reset();
        doSearch();
    }
    function add0(m){return m<10?'0'+m:m }
    function format(timestamp)
    {
        //timestamp是整数，否则要parseInt转换,不会出现少个0的情况

        var time = new Date(timestamp);
        var year = time.getFullYear();
        var month = time.getMonth()+1;
        var date = time.getDate();
        var hours = time.getHours();
        var minutes = time.getMinutes();
        var seconds = time.getSeconds();
        return year+'-'+add0(month)+'-'+add0(date);
    }


</script>

</body>
</html>
