<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>问卷套餐管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../Styles/themes/default/style.css" media="all">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../Scripts/libs/ztree/css/demo.css" media="all">
    <link rel="stylesheet" href="../../../Scripts/libs/ztree/css/metroStyle/metroStyle.css" type="text/css">
</head>
<body>
<div class="eui-bg-white eui-row eui-paddingT10">
    <div class="eui-col-md12 eui-paddingR10">
        <!--<form class="eui-form" id="searchFrom">
            <div class="eui-input-inline eui-padding10">
                <input type="text" name="roleName" e-verify="title" autocomplete="off" placeholder="角色名称/关键字" class="eui-input">
            </div>
            <div class="eui-input-inline">
                <span class="eui-btn" onclick="doSearch()">查询</span>
                <span class="eui-btn eui-btn-primary" onclick="resetForm()">重置</span>
            </div>
        </form>-->

        <div class="eui-row eui-padding10 eui-borderB">
            <div class="eui-col-md6 eui-font18">
                <i class='eui-icon eui-font24'>&#xe61d;</i> 套餐
            </div>
            <div class="eui-col-md6 eui-textAlignR">
                <a href="###" class="eui-btn eui-btn-small productNew"><i class='eui-icon eui-font24'>&#xe654;</i> 设置套餐</a>
                <a href="###" class="eui-btn eui-btn-small productDelete"><i class='eui-icon eui-font24'>&#xe640;</i> 批量删除</a>
            </div>
        </div>
        <table class="eui-table eui-form" id="userTable">
            <colgroup>
                <col width="60">
                <col>
            </colgroup>
            <thead>
            <tr>
                <th><input type="checkbox" name="" title="" e-filter="allChoose" e-skin="primary"></th>
                <th>套餐编号</th>
                <th>套餐名称</th>
                <th>问卷数量</th>
                <th>套餐价格</th>
                <th>创建人</th>
                <th>创建时间</th>
                <th>参与的活动</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
        <div style="margin-left: 30px;" id="pages"></div>
    </div>
</div>

<!-- 左滑新建套餐开始 -->
<div class="taskFiltrate">
</div>
<div class="filtrateIn">
    <div class="eui-row eui-padding10 eui-borderB">
        <div class="eui-col-md10 eui-font18 eui-lineHeight30">
            <i class='eui-icon eui-font24'>&#xe654;</i> 新建套餐
        </div>
        <div class="eui-col-md2 eui-textAlignR">
            <i class='eui-icon eui-font24 productClose'>&#x1006;</i>
        </div>
    </div>
    <form class="eui-form eui-marginT10 eui-paddingR10" id="productNewForm">
        <div class="eui-form-item">
            <label class="eui-form-label">套餐名称</label>
            <div class="eui-input-block">
                <input type="text" name="productName" e-verify="title" autocomplete="off" placeholder="请输入套餐名称"
                       class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">问卷数量</label>
            <div class="eui-input-block">
                <input type="text" name="productTotal" e-verify="title" autocomplete="off" placeholder="请输入套餐数量"
                       class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">套餐价格</label>
            <div class="eui-input-block">
                <input type="text" name="productPrice" e-verify="title" autocomplete="off" placeholder="请输入套餐价格"
                       class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">参与的促销</label>
            <div class="eui-input-block">
                <select name="promotionId" id="promotionsId" e-filter="allChoose">
                    <option value="">请选择</option>
                </select>
            </div>
        </div>
    </form>
    <div class="taskConfirm"><span onclick="addProduct()" class="eui-btn">确认</span></div>
</div>
<!-- 左滑新建角色结束 -->


<!-- 左滑编辑套餐开始 -->
<div class="taskFiltrate2">
</div>
<div class="filtrateIn2">
    <div class="eui-row eui-padding10 eui-borderB">
        <div class="eui-col-md10 eui-font18 eui-lineHeight30">
            <i class='eui-icon eui-font24'>&#xe642;</i> 编辑套餐
        </div>
        <div class="eui-col-md2 eui-textAlignR">
            <i class='eui-icon eui-font24 productClose'>&#x1006;</i>
        </div>
    </div>
    <form class="eui-form eui-marginT10 eui-paddingR10">
        <input type="hidden" id="id_edit"/>
        <div class="eui-form-item">
            <label class="eui-form-label">套餐名称</label>
            <div class="eui-input-block">
                <input type="text" id="name_edit" e-verify="title" autocomplete="off" class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">问卷数量</label>
            <div class="eui-input-block">
                <input type="text" id="total_edit" e-verify="title" autocomplete="off" class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">套餐价格</label>
            <div class="eui-input-block">
                <input type="text" id="price_edit" e-verify="title" autocomplete="off" class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">参与的活动</label>
            <div class="eui-input-block">
                <select id="product_edit" e-filter="allSelected">

                </select>
            </div>
        </div>
    </form>
    <div class="productConfirm"><span onclick="updateProduct()" class="eui-btn">确认</span></div>
</div>
<!-- 左滑编辑套餐结束 -->

<script src="../../../Scripts/module/eui.js" charset="utf-8"></script>
<script src="../../../Scripts/main.js" charset="utf-8"></script>
<script type="text/javascript" src="../../../Scripts/jquery-1.9.0.min.js"></script>

<!-- ztree -->
<script src="../../../Scripts/libs/ztree/js/jquery.ztree.core.js"></script>
<script src="../../../Scripts/libs/ztree/js/jquery.ztree.excheck.js"></script>
<script src="../../../Scripts/libs/ztree/js/jquery.ztree.exedit.js"></script>

<script src="/Scripts/libs/ligerUI/js/ligerui.all.js" type="text/javascript"></script>
<script src="/pack.ajax.js" type="text/javascript"></script>
<script src="/Scripts/date2format.js" type="text/javascript"></script>


<script>
    var promotionName = "";//活动名称
    var promotionNameEdit = "";//要修改的活动名称
    // 表单
    eui.use(['element', 'form', 'layedit', 'laydate', 'laypage', 'layer'], function () {
        var form = eui.form
                , layer = eui.layer
                , layedit = eui.layedit
                , laydate = eui.laydate
                , laypage = eui.laypage
                , $ = eui.jquery,
                element = eui.element;

        form.on('select(allChoose)', function (data) {
            promotionName = data.elem[data.elem.selectedIndex].text;
        })

        form.on('select(allSelected)', function (data) {
            promotionNameEdit = data.elem[data.elem.selectedIndex].text;
            console.log(promotionNameEdit);
        })
        //全选
        form.on('checkbox(allChoose)', function (data) {
            var child = $(data.elem).parents('table').find('tbody input[type="checkbox"]');
            child.each(function (index, item) {
                item.checked = data.elem.checked;
            });
            form.render('checkbox');
        });

        //日期范围
        laydate.render({
            elem: '#test6'
            , range: true
        });

    });

    var newCount = 1;
    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0) return;
        var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                + "' title='add node' onfocus='this.blur();'></span>";
        sObj.after(addStr);
        var btn = $("#addBtn_" + treeNode.tId);
        if (btn) btn.bind("click", function () {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo", "treeDemo2");
            zTree.addNodes(treeNode, {id: (100 + newCount), pId: treeNode.id, name: "new node" + (newCount++)});
            return false;
        });
    }
    ;
    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_" + treeNode.tId).unbind().remove();
    }
    ;

    eui.use('form', function () { //独立版的layer无需执行这一句
        var form = eui.form; //独立版的layer无需执行这一句

        // 新建角色
        $(".taskFiltrate").hide();
        $(".productNew").click(function (event) {
            $.get("/questionnaire/promotions/getState", function (result) {
                if (result.message == "SUCCESS") {
                    var form = eui.form;
                    var promotion = result.data;
                    var selectHtml = '<option value="">请选择</option>';
                    for (var index in promotion) {
                        var promotionList = promotion[index];
                        selectHtml += '<option value="' + promotionList.id + '">'
                                + promotionList.promotionsName +
                                '</option>';
                        continue;
                    }
                    $('#promotionsId').html(selectHtml);
                    $(".taskFiltrate").show();
                    $(".filtrateIn").animate({right: '0'}, 400);
                    form.render();
                }
            })
            /* Act on the event */
        });

        $(".productClose,.taskFiltrate,.productConfirm").click(function (event) {
            promotionName = "";
            $('input[name="productTotal"]').val("");
            $('input[name="productPrice"]').val("");
            $('input[name="productName"]').val("");
            $(".filtrateIn").animate({right: '-400px'}, 400);
            $(".taskFiltrate").hide();
            form.render();
        });

        // 套餐Edit
        $(".taskFiltrate2").hide();
        $(".proEdit").click(function (event) {
            $(".taskFiltrate2").show();
            $(".filtrateIn2").animate({right: '0'}, 400);
            /* Act on the event */
        });

        $(".productClose,.taskFiltrate2,.productConfirm").click(function (event) {
            $(".filtrateIn2").animate({right: '-400px'}, 400);
            $(".taskFiltrate2").hide();
        });
    });


    eui.use('layer', function () { //独立版的layer无需执行这一句
        var $ = eui.jquery, layer = eui.layer; //独立版的layer无需执行这一句

        //触发事件
        var active = {
            offset: function (othis) {
                var type = othis.data('type')
                        , text = othis.text();

                layer.open({
                    type: 1
                    , title: '检索负责人'
                    , area: ['700px', '500px']
                    , offset: type
                    , content: $("#principalAdd")
                    , btn: ['保存', '取消']
                    , btnAlign: 'c' //按钮居中
                    , yes: function () {
                        layer.closeAll();
                    }
                });
            }


        };

        $('.eui-btn,.eui-icon').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });

    });

</script>


<script type="text/javascript">

    $(function () {
        doSearch();
    });

    function resetForm() {
        document.getElementById('searchFrom').reset()
    }

    //加载数据
    function doSearch() {
        eui.use(['form', 'laypage', 'layer'], function () {
            var form = eui.form
                    , laypage = eui.laypage
                    , layer = eui.layer,
                    $ = eui.jquery;
            //全选
            form.on('checkbox(allChoose)', function (data) {
                var child = $(data.elem).parents('table').find('tbody input[type="checkbox"]');
                child.each(function (index, item) {
                    item.checked = data.elem.checked;
                });
                form.render('checkbox');
            });

            var params = $("#searchFrom").serializeObject();
            var index = layer.load(2); //加载
            $.ajax({
                url: "/product/settings/listByPage",
                data: {
                    page: 1,
                    size: 10
                },
                type: "post",
                success: function (result) {
                    layer.closeAll();
                    // 分页
                    laypage.render({
                        elem: 'pages'
//                        ,pages: result.data.pages
                        , count: result.data.total //数据总数
                        , layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        , skip: true
                        , jump: function (obj, first) {
                            if (first) {
                                //第一次，不需要查询数据
                                var userList = result.data.list;
                                console.log(userList);
                                //遍历，拼接表格
                                var tableHtml = getTable(userList);
                                $("#userTable tbody").html(tableHtml);
                                form.render('checkbox');
                            } else {
                                var params = $("#searchFrom").serializeObject();
                                $.ajax({
                                    url: "/product/settings/list",
                                    data: {
                                        roleJson: JSON.stringify(params),
                                        page: obj.curr,
                                        pagesize: obj.limit
                                    },
                                    type: "post",
                                    success: function (result) {
                                        var userList = result.data.list;
                                        //遍历，拼接表格
                                        var tableHtml = getTable(userList);
                                        $("#userTable tbody").html(tableHtml);
                                        //重新加载复选框
                                        form.render('checkbox');
                                    }
                                });
                            }
                        }
                    });
                }
            });

        });
    }


    //渲染数据，拼接表格
    function getTable(userList) {
        var tableHtml = '';
        for (var item in userList) {
            var prodouct = userList[item];

            var id = "'" + prodouct.id + "'";
            tableHtml += '<tr>' +
                    '<td><input name="" e-skin="primary" class="mycheckbox" type="checkbox"><input name="productId" type="hidden" value="' + prodouct.id + '"></td>' +
                    '<td>' + prodouct.productCode + '</td>' +
                    '<td>' + prodouct.productName + '</td>' +
                    '<td>' + prodouct.productTotal + '</td>' +
                    '<td>' + prodouct.productPrice + '元</td>' +
                    '<td>' + prodouct.creator + '</td>' +
                    '<td>' + new Date(prodouct.createTime).Format('yyyy-MM-dd') + '</td>';
            prodouct.promotionsName != "" ? tableHtml += '<td>' + prodouct.promotionsName + '</td>' : tableHtml += '<td>不参与活动</td>'
            tableHtml += '<td>' +
                    '<div class="eui-btn-group"> ' +
                    '' + Buts(prodouct.id, prodouct.productTotal, prodouct.productPrice,prodouct.productName,prodouct.promotionsName) + '' +
                    '</div>' +
                    '</td>' +
                    '</tr>';

        }
        return tableHtml;
    }

    function Buts(id, total, price,name,proName) {
        id = "'" + id + "'";
        var total = "'" + total + "'";
        var price = "'" + price + "'";
        var name="'"+name+"'";
        var proName="'"+proName+"'";
        return '<button class="eui-btn eui-btn-primary eui-btn-mini proEdit" title="编辑套餐" onclick="productEdit(' + id + ',' + total + ',' + price + ','+name+','+proName+')"><i class="eui-icon">&#xe642;</i></button> ' +
                '<button class="eui-btn eui-btn-primary eui-btn-mini" title="删除套餐" onclick="deletePrpduct(' + id + ')"><i class="eui-icon">&#xe640;</i></button> ';

    }


    //显示编辑套餐的表单
    function productEdit(id, total, price, name,proName) {
        eui.use(['form'], function () {
            var form=eui.form;
            $("#total_edit").val(total);
            $("#price_edit").val(price);
            $("#name_edit").val(name);
            $("#id_edit").val(id);
            $.get("/questionnaire/promotions/getState", function (result) {
                if (result.message == "SUCCESS") {
                    var promotion = result.data;
                    var selectHtml = '<option value="">不参与活动</option>';
                    for (var index in promotion) {
                        var promotionList = promotion[index];
                        if (proName == promotionList.promotionsName) {
                            selectHtml += '<option value="' + promotionList.id + '" selected>'
                                    + promotionList.promotionsName +
                                    '</option>';
                            continue;
                        }
                        selectHtml += '<option value="' + promotionList.id + '">'
                                + promotionList.promotionsName +
                                '</option>';
                        continue;
                    }
                    $('#product_edit').html(selectHtml);
                    form.render('select');
                }
                $(".taskFiltrate2").show();
                $(".filtrateIn2").animate({right: '0'}, 400);
            })
        })
    }
    /**
     * 修改套餐
     * @param s
     * @param id
     * @param total
     * @param price
     */
    function updateProduct() {
        var total = $.trim($("#total_edit").val());
        var price = $.trim($("#price_edit").val());
        var name = $.trim($("#name_edit").val());
        var promotionId = $.trim($("#product_edit").val());
        if (total != '' && price != '' && name!="") {
            var indexs = layer.load(2); //加载
            var obj = new Object();
            obj.productTotal = total;
            obj.productPrice = price;
            obj.productName=name;
            obj.promotionsId=promotionId;
            obj.promotionsName=promotionNameEdit;
            obj.id = $("#id_edit").val();
            $.post("/product/settings/update", {"productJson": JSON.stringify(obj)}, function (result) {
                if (result.message = 'SUCCESS') {
                    //关闭
                    layer.closeAll();
                    doSearch();
                    layer.msg('编辑成功！', {
                        time: 1500 //1秒关闭（如果不配置，默认是3秒）
                    });
                } else {
                    layer.close(indexs);
                    layer.msg('添加失败！', {
                        time: 1500 //1秒关闭（如果不配置，默认是3秒）
                    });

                }
            });
        } else {
            layer.msg('套餐名称、问卷数量和套餐价格都不能为空！', {
                time: 2000 //1秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    /**
     * 添加活动
     */
    function addProduct() {
        var params = $('#productNewForm').serializeObject();
        params.promotionsName = promotionName;
        console.log(params);
        if (params.productTotal != '' && params.productPrice != '') {
            var indexs = layer.load(2); //加载
            var obj = new Object();
            $.post("/product/settings/add", {"productJson": JSON.stringify(params)}, function (result) {
                if (result.message = 'SUCCESS') {
                    //关闭
                    //关闭
                    $(".taskFiltrate").hide();
                    $(".filtrateIn").animate({right: '-400px'}, 400);
                    layer.closeAll();
                    layer.msg('新建成功！', {
                        time: 1500 //1秒关闭（如果不配置，默认是3秒）
                    });
                    doSearch();
                    promotionName = "";
                    $('input[name="productTotal"]').val("");
                    $('input[name="productPrice"]').val("");
                    $('input[name="productName"]').val("");
                } else {
                    layer.close(indexs);
                    layer.msg('新建失败！', {
                        time: 1500 //1秒关闭（如果不配置，默认是3秒）
                    });

                }
            });
        } else {
            layer.msg('问卷数量和套餐价格不能为空！', {
                time: 2000 //1秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    /**
     * 删除套餐
     * @param id
     */
    function deletePrpduct(id) {
        var indexs = layer.load(2); //加载
        $.postStatus('/product/settings/deleteBacth', {ids: id}, function (data) {
            layer.closeAll();
            doSearch();
        });
    }

    /**
     * 删除套餐
     * @param id
     */
    $('.productDelete').click(function () {
        var ids = "";
        if (ids == "") {
            var idArray = new Array();
            var s = 0;
            $(".mycheckbox:checked").each(function (i) {
                var id = $(this).parent().find("input[name='productId']").val();
                idArray[s] = id;
                s++;
            });
            ids = idArray.join(",");
            console.log(ids);
        }
        if (ids == "") {
            layer.msg('请选择要删除的套餐', {
                icon: 2,
                time: 2000
            });
        } else {
            layer.confirm('您确定删除吗？', {
                btn: ['确认', '取消']
            }, function () {
                $.post('/product/settings/deleteBacth', {"ids": ids}, function (result) {
                    if (result.message = "SUCCESS") {
                        doSearch();
                        layer.msg('删除成功', {
                            icon: 1,
                            time: 2000
                        });
                    } else {
                        layer.msg(result.message, {
                            icon: 1,
                            time: 2000
                        });
                    }
                })
            });
        }
    })
</script>
</body>
</html>
