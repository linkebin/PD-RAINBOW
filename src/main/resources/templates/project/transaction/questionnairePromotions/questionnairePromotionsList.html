<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>促销活动管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../Styles/themes/default/style.css" media="all">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../Scripts/libs/ztree/css/demo.css" media="all">
    <link rel="stylesheet" href="../../../Scripts/libs/ztree/css/metroStyle/metroStyle.css" type="text/css">
    <script src="../../../Scripts/module/eui.js" charset="utf-8"></script>
    <script src="../../../Scripts/main.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../Scripts/jquery-1.9.0.min.js"></script>
    <!-- ztree -->
    <script src="../../../Scripts/libs/ztree/js/jquery.ztree.core.js"></script>
    <script src="../../../Scripts/libs/ztree/js/jquery.ztree.excheck.js"></script>
    <script src="../../../Scripts/libs/ztree/js/jquery.ztree.exedit.js"></script>

    <script src="/Scripts/libs/ligerUI/js/ligerui.all.js" type="text/javascript"></script>
    <script src="/pack.ajax.js" type="text/javascript"></script>
    <script src="/Scripts/date2format.js" type="text/javascript"></script>
</head>
<body>
<div class="eui-bg-white eui-row eui-paddingT10">
    <div class="eui-col-md12 eui-paddingR10">
        <div class="eui-row eui-padding10 eui-borderB">
            <div class="eui-col-md6 eui-font18">
                <i class='eui-icon eui-font24'>&#xe61d;</i> 活动
            </div>
            <div class="eui-col-md6 eui-textAlignR">
                <a href="###" class="eui-btn eui-btn-small promotionNew"><i class='eui-icon eui-font24'>&#xe654;</i>设置活动</a>
            </div>
        </div>
        <table class="eui-table eui-form" id="promotionTable">
            <colgroup>
                <col width="60">
                <col>
            </colgroup>
            <thead>
            <tr>
                <th><input type="checkbox" name="" title="" e-filter="allChoose" e-skin="primary"></th>
                <th>促销类型</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>折扣</th>
                <th>购买次数</th>
                <th>赠送数量</th>
                <th>是否启用</th>
                <th>创建人</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
        <div style="margin-left: 30px;" id="pages"></div>
    </div>
</div>

<!-- 左滑新建活动开始 -->
<div class="taskFiltrate">
</div>
<div class="filtrateIn">
    <div class="eui-row eui-padding10 eui-borderB">
        <div class="eui-col-md10 eui-font18 eui-lineHeight30" id="upOrAdd">
            <i class='eui-icon eui-font24'>&#xe654;</i> 新建活动
        </div>
        <div class="eui-col-md2 eui-textAlignR">
            <i class='eui-icon eui-font24 promotionClose'>&#x1006;</i>
        </div>
    </div>
    <form class="eui-form eui-marginT10 eui-paddingR10" id="promotionForm">
        <input type="hidden" name="id" id="questionId">
        <div class="eui-form-item">
            <label class="eui-form-label">活动类型</label>
            <div class="eui-input-block">
                <input type="radio" name="promotionsType" value="1" title="套餐折扣" checked e-filter="allChoose">
                <input type="radio" name="promotionsType" value="2" title="多买多送" e-filter="allChoose">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">折扣</label>
            <div class="eui-input-block">
                <select name="promotionsDiscount" id="Discount">
                    <option value="0.09">9折</option>
                    <option value="0.08">8折</option>
                    <option value="0.07">7折</option>
                    <option value="0.06">6折</option>
                    <option value="0.05">5折</option>
                    <option value="0.04">4折</option>
                    <option value="0.03">3折</option>
                    <option value="0.02">2折</option>
                    <option value="0.01">1折</option>
                </select>
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">开始时间</label>
            <div class="eui-input-inline">
                <input type="text" class="eui-input" name="promotionsStart" id="startTime" placeholder="年-月-日">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">结束时间</label>
            <div class="eui-input-inline">
                <input type="text" class="eui-input" name="promotionsEnd" id="endTime" placeholder="年-月-日">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">购买次数</label>
            <div class="eui-input-block">
                <input type="text" name="buyTotal" e-verify="title" autocomplete="off" class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">赠送数量</label>
            <div class="eui-input-block">
                <input type="text" name="promotionsBuySend" e-verify="title" autocomplete="off" class="eui-input">
            </div>
        </div>
        <div class="eui-form-item">
            <label class="eui-form-label">是否开启</label>
            <div class="eui-input-block">
                <input type="radio" name="promotionsState" value="0" title="是" checked>
                <input type="radio" name="promotionsState" value="1" title="否">
            </div>
        </div>
    </form>
    <div class="promotionConfirm">
        <span onclick="addOrUpPromotion()" class="eui-btn">确认</span>
    </div>
</div>
<!-- 左滑新建活动结束 -->


<script type="text/javascript">
    eui.use(['form'], function () {
        var form = eui.form, $ = eui.jquery;
        form.on('radio(allChoose)', function (data) {
            var child = $(data.elem).parents('div').find('input[name="promotionsBuySend"]');
            var child1 = $(data.elem).parents('div').find('select[name="promotionsDiscount"]');
            child.each(function (index, item) {
                child1.each(function (indexs, item1) {
                    if (data.value == 1) {
                        item.readOnly = 'readOnly';
                        item1.disabled = '';
                    } else {
                        item.readOnly = '';
                        item1.disabled = 'disabled';
                    }
                })
            });
            form.render();
        });
    });
    // 日期和时间选择
    eui.use('laydate', function () {
        var laydate = eui.laydate;

        //常规用法
        laydate.render({
            elem: '#startTime',
            type: 'datetime'
        });
        laydate.render({
            elem: '#endTime',
            type: 'datetime'
        });
    })
    $(function () {
        doSearch();
    });

    //加载数据
    function doSearch() {
        eui.use(['form', 'laypage', 'layer'], function () {
            var form = eui.form
                    , laypage = eui.laypage
                    , layer = eui.layer,
                    $ = eui.jquery;
            //全选
            form.on('checkbox(allChoose)', function (data) {
                var child = $(data.elem).parents('table').find('tbody input[type="checkbox"]');
                console.log(child);
                child.each(function (index, item) {
                    item.checked = data.elem.checked;
                });
                form.render('checkbox');
            });

            var params = $("#searchFrom").serializeObject();
            var index = layer.load(2); //加载
            $.ajax({
                url: "/questionnaire/promotions/listByPage",
                data: {
                    page: 1,
                    size: 10
                },
                type: "post",
                success: function (result) {
                    layer.closeAll();
                    // 分页
                    laypage.render({
                        elem: 'pages'
//                        ,pages: result.data.pages
                        , count: result.data.total //数据总数
                        , layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        , skip: true
                        , jump: function (obj, first) {
                            if (first) {
                                //第一次，不需要查询数据
                                var promotionList = result.data.list;
                                //遍历，拼接表格
                                var tableHtml = getTable(promotionList);
                                $("#promotionTable tbody").html(tableHtml);
                                form.render('checkbox');
                            } else {
                                var params = $("#searchFrom").serializeObject();
                                $.ajax({
                                    url: "/questionnaire/promotions/list",
                                    type: "post",
                                    success: function (result) {
                                        var promotionList = result.data.list;
                                        //遍历，拼接表格
                                        var tableHtml = getTable(promotionList);
                                        $("#promotionTable tbody").html(tableHtml);
                                        //重新加载复选框
                                        form.render('checkbox');
                                    }
                                });
                            }
                        }
                    });
                }
            });

        });
    }
    //渲染数据，拼接表格
    function getTable(userList) {
        console.log(userList);
        var tableHtml = '';
        for (var item in userList) {
            var promotion = userList[item];

            var id = "'" + promotion.id + "'";
            tableHtml += '<tr>' +
                    '<td><input name="" e-skin="primary" class="mycheckbox" type="checkbox"><input name="userId" type="hidden" value="' + promotion.id + '"></td>';

            promotion.promotionsType == 1 ? tableHtml += '<td>限时折扣</td>' : tableHtml += '<td>限时买送</td>';

            tableHtml +=
                    '<td>' + new Date(promotion.promotionsStart).Format('yyyy-MM-dd hh:mm:ss') + '</td>' +
                    '<td>' + new Date(promotion.promotionsEnd).Format('yyyy-MM-dd') + '</td>' +
                    '<td>' + promotion.promotionsDiscount + '</td>' +
                    '<td>' + promotion.buyTotal + '</td>' +
                    '<td>' + promotion.promotionsBuySend + '</td>';

            promotion.promotionsState == 0 ? tableHtml += '<td>是</td>' : tableHtml += '<td>否</td>'

            tableHtml +=
                    '<td>' + promotion.creator + '</td>' +
                    '<td>' + new Date(promotion.createTime).Format('yyyy-MM-dd') + '</td>' +
                    '<td>' +
                    '<div class="eui-btn-group"> ' +
                    '' + Buts(promotion) + '' +
                    '</div>' +
                    '</td>' +
                    '</tr>';
        }
        return tableHtml;
    }
    function Buts(promotion) {
        var id = "'" + promotion.id + "'";
        var start = "'" + new Date(promotion.promotionsStart).Format('yyyy-MM-dd') + "'";
        var end = "'" + new Date(promotion.promotionsEnd).Format('yyyy-MM-dd') + "'";
        var discount = "'" + promotion.promotionsDiscount + "'";
        var buyTotal = "'" + promotion.buyTotal + "'";
        var buySend = "'" + promotion.promotionsBuySend + "'";
        var type = "'" + promotion.promotionsType + "'";
        var state = "'" + promotion.promotionsState + "'";
        return '<button class="eui-btn eui-btn-primary eui-btn-mini promotionEdit " title="编辑活动" onclick="promotionEdit(' + id + ',' + start + ',' + end + ',' + discount + ',' + buyTotal + ',' + buySend + ',' + type + ',' + state + ')"><i class="eui-icon">&#xe642;</i></button> ' +
                '<button class="eui-btn eui-btn-primary eui-btn-mini" title="删除活动" onclick="deletePromotion(' + id + ')"><i class="eui-icon">&#xe640;</i></button> ';
    }
    /**
     *
     * 编辑活动
     */
    function promotionEdit(id, start, end, discount, buyTotal, buySend, type, state) {
        $('#questionId').val(id);
        $("#upOrAdd").text("编辑活动");
        eui.use(['form', 'laypage', 'layer'], function () {
            var form = eui.form;
            $("#Discount option[value='"+discount+"']").attr("selected", true);
            console.log(type)
            if(type==1){
                $("input[name='promotionsType']:eq(0)").attr("checked",true);
            }else{
                $("input[name='promotionsType']:eq(1)").attr("checked",true);
            }
            $("input[name='promotionsStart']").val(start);
            $("input[name='promotionsEnd']").val(end);
            $("input[name='buyTotal']").val(buyTotal);
            $("input[name='promotionsBuySend']").val(buySend);
            $("input[name='promotionsState']").val(state);
            form.render()
            /*$("input[name='promotionsType']").each(function () {
                console.log($(this).val())
                console.log(type);
                if($(this).val()==type){
                    console.log("加上")
                    $(this).attr("checked",'checked');
                }
            })*/
        });
        $('.taskFiltrate').show();
        $(".filtrateIn").animate({right: '0'}, 400);
    }
    /**
     * 删除活动
     * @param id
     */

    function deletePromotion(id) {
        var indexs = layer.load(2); //加载
        $.post("/questionnaire/promotions/delete", {id: id}, function (result) {
            if (result.code == 200) {
                layer.closeAll();
                layer.msg('删除成功！', {
                    time: 1500 //1秒关闭（如果不配置，默认是3秒）
                });
                doSearch();
            } else {
                layer.close(indexs);
                layer.msg('新建失败！', {
                    time: 1500 //1秒关闭（如果不配置，默认是3秒）
                });
            }
        })
    }
    /**
     * 新建活动
     */
    function addOrUpPromotion() {
        var params = $("#promotionForm").serializeObject();
        if (params.promotionsStart.trim() == "") {
            layer.msg('开始时间不能为空！');
            return;
        }
        else if (params.promotionsEnd.trim() == "") {
            layer.msg('结束时间不能为空！');
            return;
        }
        else if (params.promotionsDiscount.trim() == "") {
            layer.msg('折扣不能为空！');
            return;
        }
        else if (params.buyTotal.trim() == "") {
            layer.msg('购买次数不能为空！');
            return;
        }
        if (params.promotionsType.trim() == 2) {
            layer.msg('赠送数量不能为空！');
            return;
        }
        console.log(params);
        if($('#questionId').val()!=''){
            $.post("/questionnaire/promotions/update", {"promotionsJson": JSON.stringify(params)}, function (result) {
                if (result.message = 'SUCCESS') {
                    console.log(result);
                    layer.closeAll();
                    doSearch();
                    layer.msg('编辑成功！', {
                        time: 2000 //1秒关闭（如果不配置，默认是3秒）
                    });

                    $(".filtrateIn").animate({right: '-400px'}, 400);
                    $(".taskFiltrate").hide();
                } else {
                    layer.close(indexs);
                    layer.msg('编辑失败！', {
                        time: 2000 //1秒关闭（如果不配置，默认是3秒）
                    });

                }
            });
            return;
        }
        $.post("/questionnaire/promotions/add", {"promotionsJson": JSON.stringify(params)}, function (result) {
            if (result.message = 'SUCCESS') {
                //关闭
                layer.closeAll();
                layer.msg('新建成功！', {
                    time: 1500 //1秒关闭（如果不配置，默认是3秒）
                });
                $("[name='promotionsStart']").val("");
                $("[name='promotionsEnd']").val("");
                $("[name='promotionsDiscount']").val("");
                $("[name='buyTotal']").val("");
                $("[name='promotionsBuySend']").val("");
                $(".filtrateIn").animate({right: '-400px'}, 400);
                $(".taskFiltrate").hide();
                doSearch();
            } else {
                layer.close(indexs);
                layer.msg('新建失败！', {
                    time: 1500 //1秒关闭（如果不配置，默认是3秒）
                });

            }
        });
    }

    // 新建活动
    $(".taskFiltrate").hide();
    $(".promotionNew,.promotionEdit").click(function (event) {
        $("input[name='promotionsStart']").val("");
        $("input[name='promotionsEnd']").val("");
        $("input[name='buyTotal']").val("");
        $("input[name='promotionsBuySend']").val("");
        $("input[name='promotionsState']").val("");
        $(".taskFiltrate").show();
        $(".filtrateIn").animate({right: '0'}, 400);
        /* Act on the event */
    });

    $(".promotionClose,.taskFiltrate").click(function (event) {
        $(".filtrateIn").animate({right: '-400px'}, 400);
        $(".taskFiltrate").hide();
    });

</script>
</body>
</html>